<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grammly âœ¦ English Quiz</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Nunito:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#D4B8E0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Grammly">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<style>
  :root {
    --mint: #A8DADC;
    --pink: #F4C2C2;
    --lavender: #D4B8E0;
    --sakura: #FFD3E0;
    --cream: #FFF8F5;
    --soft-white: #FEFEFE;
    --text-dark: #3D3250;
    --text-mid: #7A6E8A;
    --text-light: #B8AECA;
    --correct: #A8DADC;
    --wrong: #F4C2C2;
    --gold: #F5C842;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Nunito', sans-serif;
    background: var(--cream);
    color: var(--text-dark);
    min-height: 100vh;
    overflow-x: hidden;
    position: relative;
  }

  /* Noise overlay */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none; z-index: 0;
  }

  /* Blob backgrounds */
  .blob {
    position: fixed;
    border-radius: 50%;
    filter: blur(80px);
    opacity: 0.35;
    pointer-events: none;
    z-index: 0;
  }
  .blob-1 { width: 400px; height: 400px; background: var(--lavender); top: -100px; right: -80px; }
  .blob-2 { width: 350px; height: 350px; background: var(--sakura); bottom: -80px; left: -60px; }
  .blob-3 { width: 250px; height: 250px; background: var(--mint); top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0.2; }

  .app {
    position: relative; z-index: 1;
    max-width: 420px;
    margin: 0 auto;
    min-height: 100vh;
    display: flex; flex-direction: column;
  }

  /* ===== SCREENS ===== */
  .screen { display: none; flex-direction: column; flex: 1; padding: 0 0 32px; animation: fadeUp 0.4s ease; }
  .screen.active { display: flex; }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(16px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* ===== HOME SCREEN ===== */
  .home-header {
    padding: 52px 28px 0;
    display: flex; justify-content: space-between; align-items: flex-start;
  }

  .logo {
    font-family: 'DM Serif Display', serif;
    font-size: 28px;
    color: var(--text-dark);
    letter-spacing: -0.5px;
  }

  .logo span {
    font-style: italic;
    background: linear-gradient(135deg, #C4A0D4, #A8DADC);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .streak-pill {
    display: flex; align-items: center; gap: 6px;
    background: white;
    border: 1.5px solid var(--sakura);
    border-radius: 20px;
    padding: 8px 14px;
    font-size: 13px;
    font-weight: 700;
    color: var(--text-dark);
    box-shadow: 0 2px 12px rgba(244,194,194,0.25);
  }

  .streak-flame { font-size: 16px; }

  /* Progress ring */
  .progress-section {
    padding: 28px 28px 0;
    display: flex; align-items: center; gap: 24px;
  }

  .ring-wrap {
    position: relative; flex-shrink: 0;
    width: 100px; height: 100px;
  }

  .ring-wrap svg { transform: rotate(-90deg); }

  .ring-center {
    position: absolute; inset: 0;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
  }

  .ring-pct {
    font-family: 'DM Serif Display', serif;
    font-size: 22px;
    color: var(--text-dark);
    line-height: 1;
  }

  .ring-label {
    font-size: 10px;
    color: var(--text-light);
    letter-spacing: 0.3px;
    margin-top: 2px;
  }

  .progress-text h2 {
    font-size: 18px;
    font-weight: 800;
    color: var(--text-dark);
    line-height: 1.3;
  }

  .progress-text p {
    font-size: 13px;
    color: var(--text-mid);
    margin-top: 4px;
  }

  /* Unit cards */
  .units-label {
    padding: 24px 28px 12px;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 1.2px;
    color: var(--text-light);
    text-transform: uppercase;
  }

  .units-scroll {
    padding: 0 28px;
    display: flex; flex-direction: column; gap: 12px;
  }

  .unit-card {
    background: white;
    border-radius: 20px;
    padding: 18px 20px;
    display: flex; align-items: center; gap: 16px;
    border: 1.5px solid transparent;
    box-shadow: 0 2px 16px rgba(61,50,80,0.06);
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
  }

  .unit-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; bottom: 0;
    width: 4px;
    border-radius: 4px 0 0 4px;
  }

  .unit-card:nth-child(1)::before { background: var(--mint); }
  .unit-card:nth-child(2)::before { background: var(--pink); }
  .unit-card:nth-child(3)::before { background: var(--lavender); }
  .unit-card:nth-child(4)::before { background: var(--sakura); }
  .unit-card:nth-child(5)::before { background: #B5E8B0; }
  .unit-card:nth-child(6)::before { background: #FDD9A0; }
  .unit-card:nth-child(7)::before { background: #A0C4FF; }

  .unit-card-weak {
    background: linear-gradient(135deg, #fff8f0 0%, #fff3e8 100%);
    border: 2px solid #FFCBA4;
  }
  .unit-card-weak::before { background: #FF9A6C !important; }
  .unit-card-weak .unit-icon { background: rgba(255,154,108,0.15) !important; }

  .question-ja {
    font-family: 'Nunito', sans-serif;
    font-size: 13px;
    color: #9B8FAE;
    margin: -4px 0 10px;
    padding: 8px 12px;
    background: rgba(212,184,224,0.12);
    border-radius: 8px;
    line-height: 1.5;
  }
    transform: translateY(-2px);
    box-shadow: 0 6px 24px rgba(61,50,80,0.1);
  }

  .unit-card:active { transform: scale(0.98); }

  .unit-icon {
    width: 44px; height: 44px;
    border-radius: 14px;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px;
    flex-shrink: 0;
  }

  .unit-card:nth-child(1) .unit-icon { background: rgba(168,218,220,0.2); }
  .unit-card:nth-child(2) .unit-icon { background: rgba(244,194,194,0.2); }
  .unit-card:nth-child(3) .unit-icon { background: rgba(212,184,224,0.2); }
  .unit-card:nth-child(4) .unit-icon { background: rgba(255,211,224,0.2); }
  .unit-card:nth-child(5) .unit-icon { background: rgba(181,232,176,0.2); }
  .unit-card:nth-child(6) .unit-icon { background: rgba(253,217,160,0.2); }
  .unit-card:nth-child(7) .unit-icon { background: rgba(160,196,255,0.2); }

  .unit-info { flex: 1; }

  .unit-name {
    font-size: 14px;
    font-weight: 700;
    color: var(--text-dark);
  }

  .unit-sub {
    font-size: 12px;
    color: var(--text-light);
    margin-top: 2px;
  }

  .unit-progress {
    width: 60px;
  }

  .unit-bar-bg {
    height: 6px;
    background: #F0EDF5;
    border-radius: 99px;
    overflow: hidden;
    margin-bottom: 4px;
  }

  .unit-bar-fill {
    height: 100%;
    border-radius: 99px;
    transition: width 1s ease;
  }

  .unit-card:nth-child(1) .unit-bar-fill { background: var(--mint); }
  .unit-card:nth-child(2) .unit-bar-fill { background: var(--pink); }
  .unit-card:nth-child(3) .unit-bar-fill { background: var(--lavender); }
  .unit-card:nth-child(4) .unit-bar-fill { background: var(--sakura); }
  .unit-card:nth-child(5) .unit-bar-fill { background: #B5E8B0; }
  .unit-card:nth-child(6) .unit-bar-fill { background: #FDD9A0; }
  .unit-card:nth-child(7) .unit-bar-fill { background: #A0C4FF; }

  .unit-pct-text {
    font-size: 11px;
    font-weight: 700;
    color: var(--text-mid);
    text-align: right;
  }

  /* Completed badge */
  .unit-done {
    width: 28px; height: 28px;
    background: linear-gradient(135deg, #A8DADC, #D4B8E0);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 14px;
    flex-shrink: 0;
  }

  /* Unit clear/master badges */
  .unit-badge-row {
    display: flex; gap: 4px; flex-shrink: 0; flex-direction: column; align-items: flex-end;
  }
  .unit-badge-pill {
    font-size: 10px; font-weight: 800;
    padding: 2px 7px; border-radius: 8px;
    letter-spacing: 0.3px; white-space: nowrap;
  }
  .unit-badge-clear {
    background: rgba(168,218,220,0.25);
    color: #4a9fa2;
    border: 1px solid rgba(168,218,220,0.5);
  }
  .unit-badge-master {
    background: rgba(245,200,66,0.2);
    color: #b8900a;
    border: 1px solid rgba(245,200,66,0.4);
  }

  /* ===== QUIZ SCREEN ===== */
  .quiz-header {
    padding: 52px 28px 0;
    display: flex; align-items: center; gap: 16px;
  }

  .back-btn {
    width: 40px; height: 40px;
    background: white;
    border: 1.5px solid #EDE8F5;
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    font-size: 18px;
    color: var(--text-mid);
    flex-shrink: 0;
    transition: all 0.2s;
  }

  .back-btn:hover { background: #F5F2FB; }

  .quiz-progress-bar {
    flex: 1;
    height: 8px;
    background: #EDE8F5;
    border-radius: 99px;
    overflow: hidden;
  }

  .quiz-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--mint), var(--lavender));
    border-radius: 99px;
    transition: width 0.5s ease;
  }

  .quiz-count {
    font-size: 13px;
    font-weight: 700;
    color: var(--text-mid);
    flex-shrink: 0;
    min-width: 40px;
    text-align: right;
  }

  .quiz-unit-tag {
    margin: 20px 28px 0;
    display: inline-flex; align-items: center; gap: 6px;
    background: rgba(212,184,224,0.2);
    border: 1.5px solid rgba(212,184,224,0.4);
    border-radius: 20px;
    padding: 6px 14px;
    font-size: 12px;
    font-weight: 700;
    color: var(--lavender);
    align-self: flex-start;
  }

  .question-area {
    padding: 20px 28px 0;
    flex: 1;
  }

  .question-text {
    font-family: 'DM Serif Display', serif;
    font-size: 22px;
    line-height: 1.5;
    color: var(--text-dark);
    margin-bottom: 8px;
  }

  .question-hint {
    font-size: 13px;
    color: var(--text-light);
    margin-bottom: 28px;
  }

  .choices {
    display: flex; flex-direction: column; gap: 12px;
  }

  .choice-btn {
    background: white;
    border: 2px solid #EDE8F5;
    border-radius: 18px;
    padding: 18px 20px;
    text-align: left;
    cursor: pointer;
    display: flex; align-items: center; gap: 14px;
    font-family: 'Nunito', sans-serif;
    font-size: 15px;
    font-weight: 600;
    color: var(--text-dark);
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
  }

  .choice-btn:hover {
    border-color: var(--lavender);
    transform: translateX(4px);
    box-shadow: 0 4px 16px rgba(212,184,224,0.25);
  }

  .choice-btn:active { transform: scale(0.98); }

  .choice-letter {
    width: 32px; height: 32px;
    background: #F5F2FB;
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 13px;
    font-weight: 800;
    color: var(--text-mid);
    flex-shrink: 0;
    transition: all 0.2s;
  }

  .choice-btn.correct {
    border-color: var(--mint);
    background: rgba(168,218,220,0.1);
    animation: correctPop 0.4s ease;
  }

  .choice-btn.correct .choice-letter {
    background: var(--mint);
    color: white;
  }

  .choice-btn.wrong {
    border-color: var(--pink);
    background: rgba(244,194,194,0.1);
    animation: shake 0.4s ease;
  }

  .choice-btn.wrong .choice-letter {
    background: var(--pink);
    color: white;
  }

  .choice-btn.disabled { pointer-events: none; opacity: 0.5; }

  @keyframes correctPop {
    0% { transform: scale(1); }
    40% { transform: scale(1.03); }
    100% { transform: scale(1); }
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-6px); }
    75% { transform: translateX(6px); }
  }

  /* Feedback overlay */
  .feedback-bar {
    margin: 20px 28px 0;
    padding: 16px 20px;
    border-radius: 18px;
    display: none;
    align-items: flex-start; gap: 12px;
    animation: fadeUp 0.3s ease;
  }

  .feedback-bar.show { display: flex; }

  .feedback-bar.correct-fb {
    background: rgba(168,218,220,0.15);
    border: 1.5px solid rgba(168,218,220,0.4);
  }

  .feedback-bar.wrong-fb {
    background: rgba(244,194,194,0.15);
    border: 1.5px solid rgba(244,194,194,0.4);
  }

  .feedback-icon { font-size: 22px; flex-shrink: 0; }

  .feedback-content { flex: 1; }

  .feedback-title {
    font-size: 14px;
    font-weight: 800;
    color: var(--text-dark);
    margin-bottom: 2px;
  }

  .feedback-note {
    font-size: 12px;
    color: var(--text-mid);
    line-height: 1.5;
  }

  .next-btn {
    margin: 16px 28px 0;
    width: calc(100% - 56px);
    padding: 18px;
    background: linear-gradient(135deg, var(--lavender), var(--mint));
    color: white;
    border: none;
    border-radius: 18px;
    font-family: 'Nunito', sans-serif;
    font-size: 16px;
    font-weight: 800;
    cursor: pointer;
    display: none;
    transition: all 0.2s;
    letter-spacing: 0.3px;
    box-shadow: 0 4px 20px rgba(168,218,220,0.4);
  }

  .next-btn.show { display: block; }
  .next-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(168,218,220,0.5); }
  .next-btn:active { transform: scale(0.98); }

  /* Particles */
  .particle {
    position: fixed;
    pointer-events: none;
    font-size: 18px;
    z-index: 100;
    animation: particleFly 1.2s ease forwards;
  }

  @keyframes particleFly {
    0% { opacity: 1; transform: translateY(0) scale(1); }
    100% { opacity: 0; transform: translateY(-100px) scale(0.5); }
  }

  /* ===== RESULT SCREEN ===== */
  .result-top {
    padding: 52px 28px 0;
    text-align: center;
  }

  .result-illustration {
    width: 120px; height: 120px;
    background: linear-gradient(135deg, rgba(212,184,224,0.3), rgba(168,218,220,0.3));
    border-radius: 40px;
    margin: 0 auto 24px;
    display: flex; align-items: center; justify-content: center;
    font-size: 56px;
    box-shadow: 0 8px 32px rgba(212,184,224,0.3);
    animation: floatIllus 3s ease-in-out infinite;
  }

  @keyframes floatIllus {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-8px); }
  }

  .result-comment {
    font-family: 'DM Serif Display', serif;
    font-size: 26px;
    color: var(--text-dark);
    line-height: 1.3;
    margin-bottom: 8px;
  }

  .result-sub {
    font-size: 14px;
    color: var(--text-mid);
  }

  .score-card {
    margin: 28px 28px 0;
    background: white;
    border-radius: 24px;
    padding: 24px;
    display: flex; gap: 16px;
    box-shadow: 0 4px 24px rgba(61,50,80,0.08);
  }

  .score-item {
    flex: 1; text-align: center;
    padding: 16px 8px;
    border-radius: 16px;
  }

  .score-item:first-child { background: rgba(168,218,220,0.15); }
  .score-item:nth-child(2) { background: rgba(245,200,66,0.15); }
  .score-item:nth-child(3) { background: rgba(212,184,224,0.15); }

  .score-number {
    font-family: 'DM Serif Display', serif;
    font-size: 30px;
    color: var(--text-dark);
    line-height: 1;
  }

  .score-label {
    font-size: 11px;
    color: var(--text-mid);
    font-weight: 700;
    letter-spacing: 0.5px;
    margin-top: 4px;
    text-transform: uppercase;
  }

  .badges-section {
    padding: 24px 28px 0;
  }

  .badges-title {
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 1px;
    color: var(--text-light);
    text-transform: uppercase;
    margin-bottom: 14px;
  }

  .badge-row {
    display: flex; gap: 12px;
  }

  .badge-chip {
    display: flex; align-items: center; gap: 8px;
    background: white;
    border: 1.5px solid #EDE8F5;
    border-radius: 14px;
    padding: 10px 14px;
    font-size: 13px;
    font-weight: 700;
    color: var(--text-dark);
    box-shadow: 0 2px 12px rgba(61,50,80,0.06);
    animation: badgePop 0.5s ease backwards;
  }

  .badge-chip:nth-child(1) { animation-delay: 0.2s; }
  .badge-chip:nth-child(2) { animation-delay: 0.4s; }

  @keyframes badgePop {
    from { opacity: 0; transform: scale(0.7); }
    to { opacity: 1; transform: scale(1); }
  }

  .result-actions {
    padding: 24px 28px 0;
    display: flex; flex-direction: column; gap: 12px;
  }

  .action-btn-primary {
    padding: 18px;
    background: linear-gradient(135deg, var(--lavender), var(--mint));
    color: white;
    border: none;
    border-radius: 18px;
    font-family: 'Nunito', sans-serif;
    font-size: 16px;
    font-weight: 800;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 4px 20px rgba(168,218,220,0.4);
  }

  .action-btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(168,218,220,0.5); }

  .action-btn-secondary {
    padding: 16px;
    background: white;
    color: var(--text-mid);
    border: 1.5px solid #EDE8F5;
    border-radius: 18px;
    font-family: 'Nunito', sans-serif;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
  }

  .action-btn-secondary:hover { background: #F5F2FB; }

  /* Nav dots (fake bottom nav) */
  .bottom-nav {
    position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
    width: 100%; max-width: 420px;
    background: rgba(255,248,245,0.92);
    backdrop-filter: blur(20px);
    border-top: 1px solid rgba(212,184,224,0.2);
    display: flex;
    padding: 12px 0 20px;
    z-index: 10;
  }

  .nav-item {
    flex: 1; display: flex; flex-direction: column;
    align-items: center; gap: 4px;
    font-size: 10px;
    font-weight: 700;
    color: var(--text-light);
    cursor: pointer;
    transition: color 0.2s;
    letter-spacing: 0.3px;
  }

  .nav-item.active { color: var(--text-dark); }

  .nav-icon { font-size: 22px; }

  /* Home screen bottom padding for nav */
  .screen { padding-bottom: 88px; }

  /* ===== RECORDS SCREEN ===== */
  .rec-header {
    padding: 52px 28px 0;
  }

  .rec-title {
    font-family: 'DM Serif Display', serif;
    font-size: 26px;
    color: var(--text-dark);
  }

  .rec-sub {
    font-size: 13px;
    color: var(--text-mid);
    margin-top: 4px;
  }

  .rec-stats-row {
    display: flex; gap: 10px;
    padding: 20px 28px 0;
  }

  .rec-stat-card {
    flex: 1;
    background: white;
    border-radius: 18px;
    padding: 16px 10px;
    text-align: center;
    box-shadow: 0 2px 14px rgba(61,50,80,0.06);
    border: 1.5px solid transparent;
  }

  .accent-mint { border-color: rgba(168,218,220,0.4); }
  .accent-lavender { border-color: rgba(212,184,224,0.4); }
  .accent-pink { border-color: rgba(244,194,194,0.4); }

  .rec-stat-num {
    font-family: 'DM Serif Display', serif;
    font-size: 26px;
    color: var(--text-dark);
    line-height: 1;
  }

  .rec-stat-label {
    font-size: 11px;
    color: var(--text-mid);
    font-weight: 700;
    margin-top: 5px;
  }

  .rec-section {
    padding: 20px 28px 0;
  }

  .rec-section-title {
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 1px;
    color: var(--text-light);
    text-transform: uppercase;
    margin-bottom: 12px;
  }

  /* Week calendar */
  .week-calendar {
    display: flex; gap: 8px;
    background: white;
    border-radius: 18px;
    padding: 16px;
    box-shadow: 0 2px 14px rgba(61,50,80,0.06);
  }

  .day-cell {
    flex: 1; text-align: center;
    display: flex; flex-direction: column;
    align-items: center; gap: 6px;
  }

  .day-label {
    font-size: 11px;
    font-weight: 700;
    color: var(--text-light);
  }

  .day-dot {
    width: 34px; height: 34px;
    border-radius: 50%;
    background: #F0EDF5;
    display: flex; align-items: center; justify-content: center;
    font-size: 15px;
    transition: all 0.3s;
  }

  .day-dot.done {
    background: linear-gradient(135deg, var(--mint), var(--lavender));
    box-shadow: 0 3px 10px rgba(168,218,220,0.5);
  }

  .day-dot.today {
    border: 2px solid var(--lavender);
  }

  .day-questions {
    font-size: 10px;
    font-weight: 700;
    color: var(--text-light);
  }

  /* Unit accuracy */
  .unit-acc-row {
    background: white;
    border-radius: 14px;
    padding: 14px 16px;
    margin-bottom: 8px;
    box-shadow: 0 2px 10px rgba(61,50,80,0.05);
    display: flex; align-items: center; gap: 12px;
  }

  .unit-acc-icon { font-size: 18px; flex-shrink: 0; }

  .unit-acc-info { flex: 1; }

  .unit-acc-name {
    font-size: 13px;
    font-weight: 700;
    color: var(--text-dark);
    margin-bottom: 5px;
  }

  .unit-acc-bar-bg {
    height: 6px;
    background: #F0EDF5;
    border-radius: 99px;
    overflow: hidden;
  }

  .unit-acc-bar-fill {
    height: 100%;
    border-radius: 99px;
    background: linear-gradient(90deg, var(--mint), var(--lavender));
    transition: width 1s ease;
  }

  .unit-acc-pct {
    font-size: 14px;
    font-weight: 800;
    color: var(--text-dark);
    min-width: 40px;
    text-align: right;
  }

  .unit-acc-empty {
    font-size: 12px;
    color: var(--text-light);
    font-style: italic;
  }

  /* History list */
  .history-item {
    background: white;
    border-radius: 14px;
    padding: 14px 16px;
    margin-bottom: 8px;
    display: flex; align-items: center; gap: 12px;
    box-shadow: 0 2px 10px rgba(61,50,80,0.05);
  }

  .history-icon { font-size: 22px; flex-shrink: 0; }

  .history-info { flex: 1; }

  .history-unit {
    font-size: 13px;
    font-weight: 700;
    color: var(--text-dark);
  }

  .history-date {
    font-size: 11px;
    color: var(--text-light);
    margin-top: 2px;
  }

  .history-score {
    font-family: 'DM Serif Display', serif;
    font-size: 16px;
    color: var(--text-dark);
    text-align: right;
  }

  .history-score span {
    font-family: 'Nunito', sans-serif;
    font-size: 11px;
    color: var(--text-light);
    font-weight: 700;
    display: block;
  }

  .history-empty {
    text-align: center;
    color: var(--text-light);
    font-size: 13px;
    padding: 28px 0;
    line-height: 2;
  }

</style>
</head>
<body>

<!-- Background blobs -->
<div class="blob blob-1"></div>
<div class="blob blob-2"></div>
<div class="blob blob-3"></div>

<!-- Loading overlay -->
<div id="loading-overlay" style="display:none;position:fixed;inset:0;z-index:200;background:rgba(255,248,245,0.9);backdrop-filter:blur(8px);flex-direction:column;align-items:center;justify-content:center;gap:16px;">
  <div style="font-size:36px;animation:floatIllus 1.5s ease-in-out infinite">ğŸŒ¸</div>
  <div style="font-family:'Nunito',sans-serif;font-size:14px;font-weight:700;color:#7A6E8A;">å•é¡Œã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
</div>

<div class="app">

  <!-- ====== HOME ====== -->
  <div class="screen active" id="home-screen">
    <div class="home-header">
      <div class="logo">gram<span>mly</span></div>
      <div class="streak-pill">
        <span class="streak-flame">ğŸ”¥</span>
        <span>7æ—¥é€£ç¶š</span>
      </div>
    </div>

    <div class="progress-section">
      <div class="ring-wrap">
        <svg width="100" height="100" viewBox="0 0 100 100">
          <circle cx="50" cy="50" r="42" fill="none" stroke="#EDE8F5" stroke-width="8"/>
          <circle cx="50" cy="50" r="42" fill="none"
            stroke="url(#ringGrad)" stroke-width="8"
            stroke-dasharray="263.9" stroke-dashoffset="105.6"
            stroke-linecap="round"/>
          <defs>
            <linearGradient id="ringGrad" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" stop-color="#A8DADC"/>
              <stop offset="100%" stop-color="#D4B8E0"/>
            </linearGradient>
          </defs>
        </svg>
        <div class="ring-center">
          <div class="ring-pct">60%</div>
          <div class="ring-label">é”æˆç‡</div>
        </div>
      </div>
      <div class="progress-text">
        <h2>èª¿å­ã„ã„ã­ï¼<br>ã“ã®ã¾ã¾ç¶šã‘ã‚ˆã† âœ¨</h2>
        <p>ã‚ã¨4å˜å…ƒã§å…¨ã‚¯ãƒªã‚¢</p>
      </div>
    </div>

    <div class="units-label">å˜å…ƒã‚’é¸ã¶</div>

    <div class="units-scroll">
      <div class="unit-card" data-unit="beå‹•è©" onclick="startQuiz('beå‹•è©', 'ğŸ’™')">
        <div class="unit-icon">ğŸ’™</div>
        <div class="unit-info">
          <div class="unit-name">beå‹•è© (am/is/are)</div>
          <div class="unit-sub">10å• Â· åˆç´š</div>
        </div>
        <div class="unit-done">âœ“</div>
      </div>
      <div class="unit-card" data-unit="ä¸€èˆ¬å‹•è©" onclick="startQuiz('ä¸€èˆ¬å‹•è©', 'ğŸŒ¸')">
        <div class="unit-icon">ğŸŒ¸</div>
        <div class="unit-info">
          <div class="unit-name">ä¸€èˆ¬å‹•è©ãƒ»ç¾åœ¨å½¢</div>
          <div class="unit-sub">10å• Â· åˆç´š</div>
        </div>
        <div class="unit-done">âœ“</div>
      </div>
      <div class="unit-card" data-unit="ç¾åœ¨é€²è¡Œå½¢" onclick="startQuiz('ç¾åœ¨é€²è¡Œå½¢', 'ğŸª„')">
        <div class="unit-icon">ğŸª„</div>
        <div class="unit-info">
          <div class="unit-name">ç¾åœ¨é€²è¡Œå½¢</div>
          <div class="unit-sub">10å• Â· ä¸­ç´š</div>
        </div>
        <div class="unit-progress">
          <div class="unit-bar-bg"><div class="unit-bar-fill" style="width:60%"></div></div>
          <div class="unit-pct-text">6/10</div>
        </div>
      </div>
      <div class="unit-card" data-unit="éå»å½¢" onclick="startQuiz('éå»å½¢', 'ğŸŒ·')">
        <div class="unit-icon">ğŸŒ·</div>
        <div class="unit-info">
          <div class="unit-name">éå»å½¢</div>
          <div class="unit-sub">10å• Â· ä¸­ç´š</div>
        </div>
        <div class="unit-progress">
          <div class="unit-bar-bg"><div class="unit-bar-fill" style="width:30%"></div></div>
          <div class="unit-pct-text">3/10</div>
        </div>
      </div>
      <div class="unit-card" data-unit="æœªæ¥å½¢" onclick="startQuiz('æœªæ¥å½¢', 'ğŸŒ¿')">
        <div class="unit-icon">ğŸŒ¿</div>
        <div class="unit-info">
          <div class="unit-name">æœªæ¥ (will / be going to)</div>
          <div class="unit-sub">10å• Â· ä¸­ç´š</div>
        </div>
        <div class="unit-progress">
          <div class="unit-bar-bg"><div class="unit-bar-fill" style="width:0%"></div></div>
          <div class="unit-pct-text">æœªæŒ‘æˆ¦</div>
        </div>
      </div>
      <div class="unit-card" data-unit="There is/are" onclick="startQuiz('There is/are', 'ğŸŒ¼')">
        <div class="unit-icon">ğŸŒ¼</div>
        <div class="unit-info">
          <div class="unit-name">There is / There are</div>
          <div class="unit-sub">10å• Â· ä¸­ç´š</div>
        </div>
        <div class="unit-progress">
          <div class="unit-bar-bg"><div class="unit-bar-fill" style="width:0%"></div></div>
          <div class="unit-pct-text">æœªæŒ‘æˆ¦</div>
        </div>
      </div>
      <div class="unit-card" data-unit="åŠ©å‹•è©can" onclick="startQuiz('åŠ©å‹•è©can', 'ğŸ«§')">
        <div class="unit-icon">ğŸ«§</div>
        <div class="unit-info">
          <div class="unit-name">åŠ©å‹•è© can</div>
          <div class="unit-sub">å…¨15å•</div>
        </div>
        <div class="unit-progress">
          <div class="unit-bar-bg"><div class="unit-bar-fill" style="width:0%"></div></div>
          <div class="unit-pct-text">æœªæŒ‘æˆ¦</div>
        </div>
      </div>

      <div class="unit-card unit-card-weak" onclick="startWeakMode()">
        <div class="unit-icon">ğŸ¯</div>
        <div class="unit-info">
          <div class="unit-name">è‹¦æ‰‹å•é¡Œãƒãƒ£ãƒ¬ãƒ³ã‚¸</div>
          <div class="unit-sub">å…¨å˜å…ƒã‹ã‚‰æ­£ç­”ç‡ãŒä½ã„å•é¡Œ</div>
        </div>
        <div class="unit-done" id="weak-arrow">â†’</div>
      </div>
    </div>
  </div>

  <!-- ====== QUIZ ====== -->
  <div class="screen" id="quiz-screen">
    <div class="quiz-header">
      <div class="back-btn" onclick="showScreen('home-screen')">â†</div>
      <div class="quiz-progress-bar">
        <div class="quiz-progress-fill" id="quiz-prog-fill" style="width:10%"></div>
      </div>
      <div class="quiz-count" id="quiz-count">1/10</div>
    </div>
    <div class="quiz-unit-tag" id="quiz-unit-tag">ğŸ’™ beå‹•è©</div>

    <div class="question-area">
      <div class="question-text" id="question-text">She ___ a student at this school.</div>
      <div class="question-ja" id="question-ja">å½¼å¥³ã¯ã“ã®å­¦æ ¡ã®ç”Ÿå¾’ã§ã™ã€‚</div>
      <div class="question-hint" id="question-hint">ç©ºæ¬„ã«å…¥ã‚‹ beå‹•è© ã‚’é¸ã¼ã†</div>
      <div class="choices" id="choices">
        <button class="choice-btn" onclick="selectAnswer(this, 0)">
          <div class="choice-letter">A</div>am
        </button>
        <button class="choice-btn" onclick="selectAnswer(this, 1)">
          <div class="choice-letter">B</div>is
        </button>
        <button class="choice-btn" onclick="selectAnswer(this, 2)">
          <div class="choice-letter">C</div>are
        </button>
        <button class="choice-btn" onclick="selectAnswer(this, 3)">
          <div class="choice-letter">D</div>be
        </button>
      </div>
    </div>

    <div class="feedback-bar" id="feedback-bar">
      <div class="feedback-icon" id="feedback-icon">âœ¨</div>
      <div class="feedback-content">
        <div class="feedback-title" id="feedback-title">æ­£è§£ï¼ã™ã”ã„ï¼</div>
        <div class="feedback-note" id="feedback-note">She ã¯ä¸‰äººç§°å˜æ•°ãªã®ã§ is ã‚’ä½¿ã„ã¾ã™ã€‚</div>
      </div>
    </div>

    <button class="next-btn" id="next-btn" onclick="nextQuestion()">ã¤ãã¸ â†’</button>
  </div>

  <!-- ====== RESULT ====== -->
  <div class="screen" id="result-screen">
    <div class="result-top">
      <div class="result-illustration" id="result-illus">ğŸŒ¸</div>
      <div class="result-comment" id="result-comment">Perfect! æº€ç‚¹ã ã‚ˆï¼</div>
      <div class="result-sub" id="result-sub">beå‹•è©ã€å®Œå…¨ãƒã‚¹ã‚¿ãƒ¼ã—ãŸâœ¨</div>
    </div>

    <div class="score-card">
      <div class="score-item">
        <div class="score-number" id="res-score">10</div>
        <div class="score-label">æ­£è§£</div>
      </div>
      <div class="score-item">
        <div class="score-number" id="res-total">10</div>
        <div class="score-label">å•é¡Œæ•°</div>
      </div>
      <div class="score-item">
        <div class="score-number" id="res-pct">100%</div>
        <div class="score-label">æ­£ç­”ç‡</div>
      </div>
    </div>

    <div class="badges-section" id="badges-section">
      <div class="badges-title">ç²å¾—ãƒãƒƒã‚¸</div>
      <div class="badge-row" id="badge-row">
        <!-- dynamically populated by showResult() -->
      </div>
    </div>

    <div class="result-actions">
      <button class="action-btn-primary" onclick="startQuiz(currentUnit, currentEmoji)">ã‚‚ã†ä¸€åº¦ã‚„ã‚‹</button>
      <button class="action-btn-secondary" onclick="showScreen('home-screen')">â† å˜å…ƒé¸æŠã«æˆ»ã‚‹</button>
    </div>
  </div>

  <!-- ====== RECORDS ====== -->
  <div class="screen" id="records-screen">
    <div class="rec-header">
      <div class="rec-title">ãã‚ã <span>ğŸ“Š</span></div>
      <div class="rec-sub">ä»Šé€±ã®å­¦ç¿’ã¾ã¨ã‚</div>
    </div>

    <div class="rec-stats-row">
      <div class="rec-stat-card accent-mint">
        <div class="rec-stat-num" id="rec-streak">0</div>
        <div class="rec-stat-label">ğŸ”¥ é€£ç¶šæ—¥æ•°</div>
      </div>
      <div class="rec-stat-card accent-lavender">
        <div class="rec-stat-num" id="rec-total-q">0</div>
        <div class="rec-stat-label">âœï¸ ç·å•é¡Œæ•°</div>
      </div>
      <div class="rec-stat-card accent-pink">
        <div class="rec-stat-num" id="rec-accuracy">-%</div>
        <div class="rec-stat-label">â­ æ­£ç­”ç‡</div>
      </div>
    </div>

    <div class="rec-section">
      <div class="rec-section-title">ä»Šé€±ã®å­¦ç¿’</div>
      <div class="week-calendar" id="week-calendar"></div>
    </div>

    <div class="rec-section">
      <div class="rec-section-title">å˜å…ƒåˆ¥ æ­£ç­”ç‡</div>
      <div class="unit-accuracy-list" id="unit-accuracy-list"></div>
    </div>

    <div class="rec-section">
      <div class="rec-section-title">æœ€è¿‘ã®æŒ‘æˆ¦</div>
      <div class="history-list" id="history-list">
        <div class="history-empty">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“<br>ã‚¯ã‚¤ã‚ºã«æŒ‘æˆ¦ã—ã¦ã¿ã‚ˆã†ï¼</div>
      </div>
    </div>
  </div>

</div><!-- /.app -->

<!-- Bottom Nav -->
<nav class="bottom-nav">
  <div class="nav-item active" id="nav-home" onclick="navTo('home-screen', this)">
    <div class="nav-icon">ğŸ“š</div>
    <span>ã¾ãªã¶</span>
  </div>
  <div class="nav-item" id="nav-badge" onclick="navTo('home-screen', this)">
    <div class="nav-icon">ğŸ†</div>
    <span>ãƒãƒƒã‚¸</span>
  </div>
  <div class="nav-item" id="nav-records" onclick="navTo('records-screen', this)">
    <div class="nav-icon">ğŸ“Š</div>
    <span>ãã‚ã</span>
  </div>
  <div class="nav-item" id="nav-profile" onclick="navTo('home-screen', this)">
    <div class="nav-icon">ğŸ‘¤</div>
    <span>ãƒ—ãƒ­ãƒ•</span>
  </div>
</nav>

<script>
// ===== NOTION å•é¡Œãƒ‡ãƒ¼ã‚¿å–å¾— =====
async function fetchQuestionsFromNotion() {
  document.getElementById('loading-overlay').style.display = 'flex';
  try {
    const res = await fetch('/.netlify/functions/questions');
    if (!res.ok) throw new Error('fetch failed');
    const data = await res.json();
    if (data.questions && Object.keys(data.questions).length > 0) {
      Object.assign(quizData, data.questions);
      updateUnitCards();
    }
  } catch (e) {
    console.warn('Notion fetch failed, using fallback data:', e.message);
  } finally {
    document.getElementById('loading-overlay').style.display = 'none';
  }
}

function updateUnitCards() {
  document.querySelectorAll('.unit-card[data-unit]').forEach(card => {
    const key = card.dataset.unit;
    const sub = card.querySelector('.unit-sub');
    if (!sub || !quizData[key]) return;
    const total = quizData[key].length;
    sub.textContent = `å…¨${total}å•`;
  });
}

// ===== DATA PERSISTENCE (localStorage) =====
const STORAGE_KEY = 'grammly_data';

function loadData() {
  try {
    return JSON.parse(localStorage.getItem(STORAGE_KEY)) || initData();
  } catch { return initData(); }
}

function initData() {
  return { streak: 0, lastDate: null, history: [], unitStats: {}, weekLog: {} };
}

function saveData(data) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function todayStr() {
  return new Date().toISOString().slice(0, 10);
}

function updateStreak(data) {
  const today = todayStr();
  if (data.lastDate === today) return;
  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);
  const yStr = yesterday.toISOString().slice(0, 10);
  data.streak = (data.lastDate === yStr) ? data.streak + 1 : 1;
  data.lastDate = today;
}

// ===== Quiz data =====
const quizData = {
  'beå‹•è©': [
    { q: 'I ___ a student.', ja: 'ç§ã¯å­¦ç”Ÿã§ã™ã€‚', level: 'åˆç´š', hint: 'ä¸»èª I ã«åˆã† beå‹•è©ã¯ï¼Ÿ', choices: ['am', 'is', 'are', 'be'], answer: 0, explain: 'I ã®ç¾åœ¨å½¢ã¯å¸¸ã« am ã‚’ä½¿ã„ã¾ã™ã€‚' },
    { q: 'She ___ very tall.', ja: 'å½¼å¥³ã¯ã¨ã¦ã‚‚èƒŒãŒé«˜ã„ã§ã™ã€‚', level: 'åˆç´š', hint: 'ä¸»èª She ã«åˆã† beå‹•è©ã¯ï¼Ÿ', choices: ['am', 'is', 'are', 'be'], answer: 1, explain: 'She ã¯ä¸‰äººç§°å˜æ•°ãªã®ã§ is ã‚’ä½¿ã„ã¾ã™ã€‚' },
    { q: '___ you happy today?', ja: 'ä»Šæ—¥ã¯å¹¸ã›ã§ã™ã‹ï¼Ÿ', level: 'åˆç´š', hint: 'ç–‘å•æ–‡ï¼ä¸»èª you ã«åˆã† beå‹•è©ã¯ï¼Ÿ', choices: ['Am', 'Is', 'Are', 'Do'], answer: 2, explain: 'You ã«ã¯ Are ã‚’ä½¿ã„ã¾ã™ã€‚Are you ~? ãŒç–‘å•å½¢ã§ã™ã€‚' },
    { q: 'They ___ not at home now.', ja: 'å½¼ã‚‰ã¯ä»Šã€å®¶ã«ã„ã¾ã›ã‚“ã€‚', level: 'åˆç´š', hint: 'ä¸»èª Theyï¼ˆè¤‡æ•°ï¼‰ã«åˆã† beå‹•è©ã¯ï¼Ÿ', choices: ['is', 'are', 'am', 'be'], answer: 1, explain: 'They ã¯è¤‡æ•°ãªã®ã§ areã€‚å¦å®šã¯ are not ã§ã™ã€‚' },
    { q: 'This ___ my cat, Momo.', ja: 'ã“ã‚ŒãŒç§ã®çŒ«ã€ãƒ¢ãƒ¢ã§ã™ã€‚', level: 'åˆç´š', hint: 'ä¸»èª Thisï¼ˆå˜æ•°ï¼‰ã«åˆã† beå‹•è©ã¯ï¼Ÿ', choices: ['am', 'is', 'are', 'be'], answer: 1, explain: 'This ã¯ä¸‰äººç§°å˜æ•°æ‰±ã„ãªã®ã§ is ã‚’ä½¿ã„ã¾ã™ã€‚' },
    { q: 'We ___ best friends!', ja: 'ç§ãŸã¡ã¯è¦ªå‹ã§ã™ï¼', level: 'åˆç´š', hint: 'ä¸»èª We ã«åˆã† beå‹•è©ã¯ï¼Ÿ', choices: ['am', 'is', 'are', 'be'], answer: 2, explain: 'We ã¯è¤‡æ•°ãªã®ã§ are ã‚’ä½¿ã„ã¾ã™ã€‚' },
    { q: 'He ___ a soccer player.', ja: 'å½¼ã¯ã‚µãƒƒã‚«ãƒ¼é¸æ‰‹ã§ã™ã€‚', level: 'åˆç´š', hint: 'ä¸»èª He ã«åˆã† beå‹•è©ã¯ï¼Ÿ', choices: ['are', 'am', 'be', 'is'], answer: 3, explain: 'He ã¯ä¸‰äººç§°å˜æ•°ãªã®ã§ is ã‚’ä½¿ã„ã¾ã™ã€‚' },
    { q: 'The books ___ on the table.', ja: 'æœ¬ã¯ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¸Šã«ã‚ã‚Šã¾ã™ã€‚', level: 'åˆç´š', hint: 'ä¸»èª The booksï¼ˆè¤‡æ•°ï¼‰ã«åˆã† beå‹•è©ã¯ï¼Ÿ', choices: ['is', 'am', 'are', 'be'], answer: 2, explain: 'The books ã¯è¤‡æ•°ãªã®ã§ are ã‚’ä½¿ã„ã¾ã™ã€‚' },
    { q: 'It ___ a beautiful day!', ja: 'ç´ æ™´ã‚‰ã—ã„å¤©æ°—ã§ã™ã­ï¼', level: 'ä¸­ç´š', hint: 'ä¸»èª It ã«åˆã† beå‹•è©ã¯ï¼Ÿ', choices: ['are', 'am', 'is', 'be'], answer: 2, explain: 'It ã¯ä¸‰äººç§°å˜æ•°ãªã®ã§ is ã‚’ä½¿ã„ã¾ã™ã€‚' },
    { q: 'My sister and I ___ twins.', ja: 'ç§ã¨å§‰ã¯åŒå­ã§ã™ã€‚', level: 'ä¸­ç´š', hint: '2äººã„ã‚‹ï¼åˆã† beå‹•è©ã¯ï¼Ÿ', choices: ['is', 'am', 'are', 'be'], answer: 2, explain: 'My sister and I ã§2äºº â†’ è¤‡æ•°æ‰±ã„ãªã®ã§ are ã§ã™ã€‚' },
  ],

  'ä¸€èˆ¬å‹•è©': [
    { q: 'He ___ soccer every Saturday.', ja: 'å½¼ã¯æ¯é€±åœŸæ›œæ—¥ã«ã‚µãƒƒã‚«ãƒ¼ã‚’ã—ã¾ã™ã€‚', level: 'åˆç´š', hint: 'ä¸»èª Heï¼ˆä¸‰å˜ç¾ï¼‰ã«åˆã†å½¢ã¯ï¼Ÿ', choices: ['play', 'plays', 'playing', 'played'], answer: 1, explain: 'ä¸‰å˜ç¾ï¼ˆHe/She/Itï¼‰ã§ã¯å‹•è©ã« -s ã‚’ã¤ã‘ã¾ã™ã€‚' },
    { q: 'We ___ to school by bus.', ja: 'ç§ãŸã¡ã¯ãƒã‚¹ã§å­¦æ ¡ã¸è¡Œãã¾ã™ã€‚', level: 'åˆç´š', hint: 'ä¸»èª We ã«åˆã†å½¢ã¯ï¼Ÿ', choices: ['go', 'goes', 'going', 'went'], answer: 0, explain: 'We ã¯è¤‡æ•°ãªã®ã§ goï¼ˆåŸå½¢ï¼‰ã‚’ä½¿ã„ã¾ã™ã€‚' },
    { q: 'She ___ English very well.', ja: 'å½¼å¥³ã¯è‹±èªã‚’ã¨ã¦ã‚‚ä¸Šæ‰‹ã«å‹‰å¼·ã—ã¾ã™ã€‚', level: 'åˆç´š', hint: 'study ã®ä¸‰å˜ç¾ã¯ï¼Ÿ -y ã«æ³¨æ„ï¼', choices: ['study', 'studys', 'studies', 'studying'], answer: 2, explain: 'å­éŸ³ + y ã§çµ‚ã‚ã‚‹å‹•è©ã¯ y â†’ ies ã«å¤‰ãˆã¾ã™ï¼ˆstudiesï¼‰ã€‚' },
    { q: 'My brother ___ TV every night.', ja: 'ç§ã®å…„ã¯æ¯æ™©ãƒ†ãƒ¬ãƒ“ã‚’è¦‹ã¾ã™ã€‚', level: 'åˆç´š', hint: 'watch ã®ä¸‰å˜ç¾ã¯ï¼Ÿ', choices: ['watch', 'watchs', 'watches', 'watching'], answer: 2, explain: '-ch ã§çµ‚ã‚ã‚‹å‹•è©ã«ã¯ -es ã‚’ã¤ã‘ã¾ã™ï¼ˆwatchesï¼‰ã€‚' },
    { q: 'I ___ like math. It\'s difficult!', ja: 'ç§ã¯æ•°å­¦ãŒå¥½ãã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚é›£ã—ã„ã§ã™ï¼', level: 'åˆç´š', hint: 'ä¸€èˆ¬å‹•è©ã®å¦å®šæ–‡ï¼ˆIï¼‰ã¯ï¼Ÿ', choices: ["don't", "doesn't", 'not', "isn't"], answer: 0, explain: 'I ã®å¦å®šã¯ do notï¼ˆdon\'tï¼‰+ å‹•è©ã®åŸå½¢ã€‚' },
    { q: 'She ___ have a pet.', ja: 'å½¼å¥³ã¯ãƒšãƒƒãƒˆã‚’é£¼ã£ã¦ã„ã¾ã›ã‚“ã€‚', level: 'åˆç´š', hint: 'ä¸‰å˜ç¾ã®å¦å®šæ–‡ã¯ï¼Ÿ', choices: ["don't", "doesn't", 'not', "isn't"], answer: 1, explain: 'She ã®å¦å®šã¯ does notï¼ˆdoesn\'tï¼‰+ å‹•è©ã®åŸå½¢ã€‚' },
    { q: '___ he like music?', ja: 'å½¼ã¯éŸ³æ¥½ãŒå¥½ãã§ã™ã‹ï¼Ÿ', level: 'åˆç´š', hint: 'ä¸‰å˜ç¾ã®ç–‘å•æ–‡ã¯ï¼Ÿ', choices: ['Do', 'Does', 'Is', 'Are'], answer: 1, explain: 'He ã®ç–‘å•æ–‡ã¯ Does + ä¸»èª + å‹•è©ã®åŸå½¢ï¼Ÿ ã§ã™ã€‚' },
    { q: 'I ___ to music every morning.', ja: 'ç§ã¯æ¯æœéŸ³æ¥½ã‚’è´ãã¾ã™ã€‚', level: 'åˆç´š', hint: 'ä¸»èª I ã«åˆã†å‹•è©ã®å½¢ã¯ï¼Ÿ', choices: ['listens', 'listen', 'listening', 'listened'], answer: 1, explain: 'I ã«ã¯å‹•è©ã®åŸå½¢ï¼ˆlistenï¼‰ã‚’ä½¿ã„ã¾ã™ã€‚' },
    { q: 'She ___ up at 6 every day.', ja: 'å½¼å¥³ã¯æ¯æ—¥6æ™‚ã«èµ·ãã¾ã™ã€‚', level: 'ä¸­ç´š', hint: 'ä¸‰å˜ç¾ï¼wake ã®ä¸‰å˜ç¾ã¯ï¼Ÿ', choices: ['wake', 'wakes', 'waking', 'waked'], answer: 1, explain: 'ä¸‰å˜ç¾ã¯åŸºæœ¬ -s ã‚’ã¤ã‘ã¾ã™ï¼ˆwakesï¼‰ã€‚' },
    { q: '___ you speak Japanese?', ja: 'ã‚ãªãŸã¯æ—¥æœ¬èªã‚’è©±ã—ã¾ã™ã‹ï¼Ÿ', level: 'ä¸­ç´š', hint: 'ä¸€èˆ¬å‹•è©ã®ç–‘å•æ–‡ï¼ˆyouï¼‰ã¯ï¼Ÿ', choices: ['Are', 'Is', 'Do', 'Does'], answer: 2, explain: 'You ã®ç–‘å•æ–‡ã¯ Do + you + å‹•è©ã®åŸå½¢ï¼Ÿ ã§ã™ã€‚' },
  ],

  'ç¾åœ¨é€²è¡Œå½¢': [
    { q: 'Look! The dog ___ now.', ja: 'è¦‹ã¦ï¼çŠ¬ãŒä»Šèµ°ã£ã¦ã„ã¾ã™ã€‚', level: 'åˆç´š', hint: 'ç¾åœ¨é€²è¡Œå½¢ã¯ be + ~ingï¼', choices: ['run', 'runs', 'is running', 'running'], answer: 2, explain: 'ç¾åœ¨é€²è¡Œä¸­ã®å‹•ä½œã¯ beå‹•è© + å‹•è©-ingï¼ˆis runningï¼‰ã€‚' },
    { q: 'We ___ lunch at school today.', ja: 'ç§ãŸã¡ã¯ä»Šæ—¥ã€å­¦æ ¡ã§æ˜¼é£Ÿã‚’é£Ÿã¹ã¦ã„ã¾ã™ã€‚', level: 'åˆç´š', hint: 'ä¸»èª We ã«åˆã†ç¾åœ¨é€²è¡Œå½¢ã¯ï¼Ÿ', choices: ['eat', 'eats', 'are eating', 'eating'], answer: 2, explain: 'We ã«ã¯ are ã‚’ä½¿ã„ã€are eating ãŒæ­£ã—ã„é€²è¡Œå½¢ã§ã™ã€‚' },
    { q: 'She ___ to music in her room.', ja: 'å½¼å¥³ã¯è‡ªåˆ†ã®éƒ¨å±‹ã§éŸ³æ¥½ã‚’è´ã„ã¦ã„ã¾ã™ã€‚', level: 'åˆç´š', hint: 'ä¸»èª She ã«åˆã†ç¾åœ¨é€²è¡Œå½¢ã¯ï¼Ÿ', choices: ['listen', 'is listening', 'listens', 'listening'], answer: 1, explain: 'She ã«ã¯ is ã‚’ä½¿ã„ã€is listening ãŒæ­£ã—ã„é€²è¡Œå½¢ã§ã™ã€‚' },
    { q: '___ you doing your homework?', ja: 'ã‚ãªãŸã¯å®¿é¡Œã‚’ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ', level: 'åˆç´š', hint: 'é€²è¡Œå½¢ã®ç–‘å•æ–‡ï¼ä¸»èª you ã«åˆã† beå‹•è©ã¯ï¼Ÿ', choices: ['Do', 'Are', 'Is', 'Does'], answer: 1, explain: 'é€²è¡Œå½¢ã®ç–‘å•æ–‡ã¯ beå‹•è©ã‚’å…ˆé ­ã«ã€‚you ãªã®ã§ Areã€‚' },
    { q: 'They ___ not playing outside. It\'s raining.', ja: 'å½¼ã‚‰ã¯å¤–ã§éŠã‚“ã§ã„ã¾ã›ã‚“ã€‚é›¨ãŒé™ã£ã¦ã„ã¾ã™ã€‚', level: 'åˆç´š', hint: 'é€²è¡Œå½¢ã®å¦å®šæ–‡ï¼ä¸»èª They ã«åˆã† beå‹•è©ã¯ï¼Ÿ', choices: ['is', 'are', 'do', 'does'], answer: 1, explain: 'They ã®é€²è¡Œå½¢ã¯ are ~ingã€‚å¦å®šã¯ are not playingã€‚' },
    { q: 'I ___ a letter to my friend now.', ja: 'ç§ã¯ä»Šã€å‹é”ã«æ‰‹ç´™ã‚’æ›¸ã„ã¦ã„ã¾ã™ã€‚', level: 'åˆç´š', hint: 'ä¸»èª I ã«åˆã†ç¾åœ¨é€²è¡Œå½¢ã¯ï¼Ÿ', choices: ['write', 'writes', 'am writing', 'writing'], answer: 2, explain: 'I ã«ã¯ am ã‚’ä½¿ã„ã€am writing ãŒæ­£ã—ã„é€²è¡Œå½¢ã§ã™ã€‚' },
    { q: 'He ___ a cake for mom\'s birthday!', ja: 'å½¼ã¯ãŠæ¯ã•ã‚“ã®èª•ç”Ÿæ—¥ã®ãŸã‚ã«ã‚±ãƒ¼ã‚­ã‚’ä½œã£ã¦ã„ã¾ã™ï¼', level: 'åˆç´š', hint: 'ä¸»èª He ã«åˆã†ç¾åœ¨é€²è¡Œå½¢ã¯ï¼Ÿ', choices: ['make', 'makes', 'is making', 'making'], answer: 2, explain: 'He ã«ã¯ is ã‚’ä½¿ã„ã€is making ãŒé€²è¡Œå½¢ã€‚make â†’ makingï¼ˆeã‚’å–ã‚‹ï¼‰ã€‚' },
    { q: 'What ___ she doing now?', ja: 'å½¼å¥³ã¯ä»Šã€ä½•ã‚’ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ', level: 'åˆç´š', hint: 'ç–‘å•è©+é€²è¡Œå½¢ï¼She ã«åˆã† beå‹•è©ã¯ï¼Ÿ', choices: ['do', 'does', 'is', 'are'], answer: 2, explain: 'What is she doing? ãŒæ­£ã—ã„èªé †ã€‚She ã«ã¯ isã€‚' },
    { q: 'The birds ___ in the sky.', ja: 'é³¥ãŸã¡ãŒç©ºã‚’é£›ã‚“ã§ã„ã¾ã™ã€‚', level: 'ä¸­ç´š', hint: 'ä¸»èª The birdsï¼ˆè¤‡æ•°ï¼‰ã«åˆã†é€²è¡Œå½¢ã¯ï¼Ÿ', choices: ['fly', 'flies', 'are flying', 'is flying'], answer: 2, explain: 'The birds ã¯è¤‡æ•°ãªã®ã§ are flying ãŒæ­£ã—ã„ã€‚' },
    { q: 'Mom ___ dinner in the kitchen.', ja: 'ãŠæ¯ã•ã‚“ã¯ã‚­ãƒƒãƒãƒ³ã§å¤•é£Ÿã‚’æ–™ç†ã—ã¦ã„ã¾ã™ã€‚', level: 'ä¸­ç´š', hint: 'ä¸»èª Momï¼ˆä¸‰äººç§°å˜æ•°ï¼‰ã«åˆã†é€²è¡Œå½¢ã¯ï¼Ÿ', choices: ['cook', 'cooks', 'are cooking', 'is cooking'], answer: 3, explain: 'Mom ã¯ä¸‰äººç§°å˜æ•°ãªã®ã§ is cooking ãŒæ­£ã—ã„é€²è¡Œå½¢ã€‚' },
  ],

  'éå»å½¢': [
    { q: 'I ___ sick yesterday.', ja: 'ç§ã¯æ˜¨æ—¥ã€ç—…æ°—ã§ã—ãŸã€‚', level: 'åˆç´š', hint: 'beå‹•è©ã®éå»å½¢ï¼I ã«åˆã†å½¢ã¯ï¼Ÿ', choices: ['am', 'was', 'were', 'is'], answer: 1, explain: 'I ã® beå‹•è©éå»å½¢ã¯ was ã§ã™ã€‚' },
    { q: 'We ___ soccer after school last Friday.', ja: 'ç§ãŸã¡ã¯å…ˆé€±é‡‘æ›œæ—¥ã€æ”¾èª²å¾Œã«ã‚µãƒƒã‚«ãƒ¼ã‚’ã—ã¾ã—ãŸã€‚', level: 'åˆç´š', hint: 'ä¸€èˆ¬å‹•è© play ã®éå»å½¢ã¯ï¼Ÿ', choices: ['play', 'played', 'playing', 'plays'], answer: 1, explain: 'è¦å‰‡å‹•è©ã®éå»å½¢ã¯ -ed ã‚’ã¤ã‘ã¾ã™ï¼ˆplayedï¼‰ã€‚' },
    { q: 'She ___ a book to me last week.', ja: 'å½¼å¥³ã¯å…ˆé€±ã€ç§ã«æœ¬ã‚’ãã‚Œã¾ã—ãŸã€‚', level: 'åˆç´š', hint: 'give ã®éå»å½¢ï¼ˆä¸è¦å‰‡å¤‰åŒ–ï¼‰ã¯ï¼Ÿ', choices: ['give', 'gives', 'gave', 'giving'], answer: 2, explain: 'give ã¯ä¸è¦å‰‡å‹•è©ã€‚éå»å½¢ã¯ gave ã§ã™ã€‚' },
    { q: '___ you at the park yesterday?', ja: 'ã‚ãªãŸã¯æ˜¨æ—¥ã€å…¬åœ’ã«ã„ã¾ã—ãŸã‹ï¼Ÿ', level: 'åˆç´š', hint: 'beå‹•è©éå»å½¢ã®ç–‘å•æ–‡ï¼you ã«åˆã†å½¢ã¯ï¼Ÿ', choices: ['Was', 'Were', 'Did', 'Are'], answer: 1, explain: 'You ã® beå‹•è©éå»å½¢ã¯ wereã€‚ç–‘å•æ–‡ã¯ Were you ~? ã§ã™ã€‚' },
    { q: 'He ___ not come to school two days ago.', ja: 'å½¼ã¯2æ—¥å‰ã€å­¦æ ¡ã«æ¥ã¾ã›ã‚“ã§ã—ãŸã€‚', level: 'åˆç´š', hint: 'ä¸€èˆ¬å‹•è©éå»å½¢ã®å¦å®šæ–‡ã¯ï¼Ÿ', choices: ['do', 'does', 'did', "didn't"], answer: 3, explain: 'éå»ã®å¦å®šã¯ did notï¼ˆdidn\'tï¼‰+ å‹•è©ã®åŸå½¢ã€‚' },
    { q: 'They ___ very tired after the game.', ja: 'å½¼ã‚‰ã¯è©¦åˆã®å¾Œã€ã¨ã¦ã‚‚ç–²ã‚Œã¦ã„ã¾ã—ãŸã€‚', level: 'åˆç´š', hint: 'beå‹•è©éå»å½¢ï¼They ã«åˆã†å½¢ã¯ï¼Ÿ', choices: ['was', 'were', 'are', 'is'], answer: 1, explain: 'They ã® beå‹•è©éå»å½¢ã¯ were ã§ã™ã€‚' },
    { q: 'I ___ to Kyoto last summer.', ja: 'ç§ã¯å»å¹´ã®å¤ã€äº¬éƒ½ã¸è¡Œãã¾ã—ãŸã€‚', level: 'åˆç´š', hint: 'go ã®éå»å½¢ï¼ˆä¸è¦å‰‡å¤‰åŒ–ï¼‰ã¯ï¼Ÿ', choices: ['go', 'goes', 'going', 'went'], answer: 3, explain: 'go ã¯ä¸è¦å‰‡å‹•è©ã€‚éå»å½¢ã¯ went ã§ã™ã€‚' },
    { q: '___ she study hard for the test?', ja: 'å½¼å¥³ã¯ãƒ†ã‚¹ãƒˆã®ãŸã‚ã«ä¸€ç”Ÿæ‡¸å‘½å‹‰å¼·ã—ã¾ã—ãŸã‹ï¼Ÿ', level: 'åˆç´š', hint: 'ä¸€èˆ¬å‹•è©éå»å½¢ã®ç–‘å•æ–‡ã¯ï¼Ÿ', choices: ['Do', 'Does', 'Did', 'Was'], answer: 2, explain: 'éå»ã®ç–‘å•æ–‡ã¯ Did + ä¸»èª + å‹•è©ã®åŸå½¢ï¼Ÿ ã§ã™ã€‚' },
    { q: 'We ___ a great time at the festival.', ja: 'ç§ãŸã¡ã¯ãŠç¥­ã‚Šã§ã¨ã¦ã‚‚æ¥½ã—ã„æ™‚é–“ã‚’éã”ã—ã¾ã—ãŸã€‚', level: 'ä¸­ç´š', hint: 'have ã®éå»å½¢ï¼ˆä¸è¦å‰‡å¤‰åŒ–ï¼‰ã¯ï¼Ÿ', choices: ['have', 'has', 'had', 'having'], answer: 2, explain: 'have ã®éå»å½¢ã¯ had ã§ã™ã€‚' },
    { q: 'My cat ___ on the sofa all day.', ja: 'ç§ã®çŒ«ã¯ä¸€æ—¥ä¸­ã‚½ãƒ•ã‚¡ã®ä¸Šã«ã„ã¾ã—ãŸã€‚', level: 'ä¸­ç´š', hint: 'beå‹•è©éå»å½¢ï¼My catï¼ˆå˜æ•°ï¼‰ã«åˆã†å½¢ã¯ï¼Ÿ', choices: ['is', 'are', 'was', 'were'], answer: 2, explain: 'My cat ã¯ä¸‰äººç§°å˜æ•°ãªã®ã§ beå‹•è©éå»å½¢ã¯ wasã€‚' },
  ],

  'æœªæ¥å½¢': [
    { q: 'I think it ___ rain this afternoon.', ja: 'ä»Šæ—¥ã®åˆå¾Œã¯é›¨ãŒé™ã‚‹ã¨æ€ã„ã¾ã™ã€‚', level: 'åˆç´š', hint: 'äºˆæ¸¬ãƒ»æ¨é‡ã®æœªæ¥ã¯ï¼Ÿ', choices: ['will', 'is going to', 'goes to', 'rained'], answer: 0, explain: 'äºˆæ¸¬ã‚„æ¨é‡ã«ã¯ will ã‚’ä½¿ã„ã¾ã™ã€‚ï¼ˆbe going to ã‚‚â—¯ï¼‰' },
    { q: 'She ___ to Tokyo next Sunday.', ja: 'å½¼å¥³ã¯æ¬¡ã®æ—¥æ›œæ—¥ã€æ±äº¬ã¸è¡Œãäºˆå®šã§ã™ã€‚', level: 'åˆç´š', hint: 'äºˆå®šã‚’è¡¨ã™ï¼be going to ã®æ­£ã—ã„å½¢ã¯ï¼Ÿ', choices: ['go', 'goes', 'is going', 'went'], answer: 2, explain: 'She ã¯ä¸‰äººç§°å˜æ•°ã€‚be going to â†’ is going to ãŒæ­£ã—ã„ã€‚' },
    { q: 'We ___ pizza for dinner tonight!', ja: 'ä»Šå¤œã¯å¤•é£Ÿã«ãƒ”ã‚¶ã‚’é£Ÿã¹ã¾ã™ï¼', level: 'åˆç´š', hint: 'æ„å¿—ãƒ»æ±ºå®šã‚’è¡¨ã™æœªæ¥ã¯ï¼Ÿ', choices: ['will eat', 'eat', 'eats', 'ate'], answer: 0, explain: 'æ„å¿—ãƒ»ãã®å ´ã§ã®æ±ºå®šã«ã¯ will + å‹•è©ã®åŸå½¢ã‚’ä½¿ã„ã¾ã™ã€‚' },
    { q: 'Look at the clouds! It ___ soon.', ja: 'é›²ã‚’è¦‹ã¦ï¼ã‚‚ã†ã™ãé›¨ãŒé™ã‚Šãã†ã§ã™ã€‚', level: 'åˆç´š', hint: 'æ ¹æ‹ ã®ã‚ã‚‹äºˆæ¸¬ï¼be going to vs will', choices: ['will rain', 'is going to rain', 'rains', 'rained'], answer: 1, explain: 'ç›®ã«è¦‹ãˆã‚‹æ ¹æ‹ ï¼ˆé›²ï¼‰ãŒã‚ã‚‹äºˆæ¸¬ã«ã¯ be going to ã‚’ä½¿ã„ã¾ã™ã€‚' },
    { q: '___ you help me with my homework?', ja: 'å®¿é¡Œã‚’æ‰‹ä¼ã£ã¦ãã‚Œã¾ã™ã‹ï¼Ÿ', level: 'åˆç´š', hint: 'ä¾é ¼ãƒ»æœªæ¥ã®ç–‘å•æ–‡ã¯ï¼Ÿ', choices: ['Will', 'Do', 'Are', 'Did'], answer: 0, explain: 'ä¾é ¼ã‚„æœªæ¥ã®ç–‘å•æ–‡ã¯ Will you ~? ã§ã™ã€‚' },
    { q: 'I ___ call you later.', ja: 'å¾Œã§é›»è©±ã—ã¾ã™ã€‚', level: 'åˆç´š', hint: 'ç´„æŸãƒ»æ„å¿—ã‚’è¡¨ã™æœªæ¥ã¯ï¼Ÿ', choices: ['will', 'am going to', 'do', 'did'], answer: 0, explain: 'ãã®å ´ã§ã®æ±ºå®šãƒ»ç´„æŸã«ã¯ will ã‚’ä½¿ã„ã¾ã™ã€‚' },
    { q: 'She ___ be 15 next month.', ja: 'å½¼å¥³ã¯æ¥æœˆ15æ­³ã«ãªã‚Šã¾ã™ã€‚', level: 'åˆç´š', hint: 'æœªæ¥ã‚’è¡¨ã™åŠ©å‹•è©ã¯ï¼Ÿ', choices: ['is', 'was', 'will', 'does'], answer: 2, explain: 'æœªæ¥ã®çŠ¶æ…‹ã‚’è¡¨ã™ã«ã¯ will + å‹•è©ã®åŸå½¢ï¼ˆwill beï¼‰ã‚’ä½¿ã„ã¾ã™ã€‚' },
    { q: 'They ___ going to visit Okinawa.', ja: 'å½¼ã‚‰ã¯æ²–ç¸„ã‚’è¨ªã‚Œã‚‹äºˆå®šã§ã™ã€‚', level: 'åˆç´š', hint: 'be going to ã®æ–‡ï¼They ã«åˆã† beå‹•è©ã¯ï¼Ÿ', choices: ['is', 'was', 'were', 'are'], answer: 3, explain: 'They ã¯è¤‡æ•°ãªã®ã§ be going to â†’ are going to ãŒæ­£ã—ã„ã€‚' },
    { q: '___ it snow tomorrow?', ja: 'æ˜æ—¥ã¯é›ªãŒé™ã‚Šã¾ã™ã‹ï¼Ÿ', level: 'ä¸­ç´š', hint: 'will ã®ç–‘å•æ–‡ï¼', choices: ['Does', 'Is', 'Will', 'Do'], answer: 2, explain: 'will ã®ç–‘å•æ–‡ã¯ Will + ä¸»èª + å‹•è©ã®åŸå½¢ï¼Ÿ ã§ã™ã€‚' },
    { q: 'I\'m not going ___ eat natto!', ja: 'ç§ã¯ç´è±†ã‚’é£Ÿã¹ã‚‹ã¤ã‚‚ã‚Šã¯ã‚ã‚Šã¾ã›ã‚“ï¼', level: 'ä¸­ç´š', hint: 'be going to ã®å¦å®šæ–‡ã®æ§‹é€ ã¯ï¼Ÿ', choices: ['to', 'for', 'at', 'with'], answer: 0, explain: 'be going to + å‹•è©ã®åŸå½¢ã€‚to ãŒå¿…è¦ã§ã™ã€‚' },
  ],

  'There is/are': [
    { q: 'There ___ a cat under the table.', ja: 'ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¸‹ã«çŒ«ãŒ1åŒ¹ã„ã¾ã™ã€‚', level: 'åˆç´š', hint: 'a catï¼ˆå˜æ•°ï¼‰ã«åˆã† beå‹•è©ã¯ï¼Ÿ', choices: ['is', 'are', 'am', 'be'], answer: 0, explain: 'a cat ã¯å˜æ•°ãªã®ã§ There is ã‚’ä½¿ã„ã¾ã™ã€‚' },
    { q: 'There ___ many students in the gym.', ja: 'ä½“è‚²é¤¨ã«ãŸãã•ã‚“ã®ç”Ÿå¾’ãŒã„ã¾ã™ã€‚', level: 'åˆç´š', hint: 'many studentsï¼ˆè¤‡æ•°ï¼‰ã«åˆã† beå‹•è©ã¯ï¼Ÿ', choices: ['is', 'are', 'am', 'be'], answer: 1, explain: 'many students ã¯è¤‡æ•°ãªã®ã§ There are ã‚’ä½¿ã„ã¾ã™ã€‚' },
    { q: '___ any milk in the fridge?', ja: 'å†·è”µåº«ã«ç‰›ä¹³ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ', level: 'åˆç´š', hint: 'milkï¼ˆä¸å¯ç®—ãƒ»å˜æ•°æ‰±ã„ï¼‰ã®ç–‘å•æ–‡ã¯ï¼Ÿ', choices: ['Is there', 'Are there', 'There is', 'There are'], answer: 0, explain: 'milk ã¯ä¸å¯ç®—åè©ï¼ˆå˜æ•°æ‰±ã„ï¼‰ãªã®ã§ Is there ã‚’ä½¿ã„ã¾ã™ã€‚' },
    { q: 'There ___ not any cookies left...', ja: 'ã‚¯ãƒƒã‚­ãƒ¼ãŒ1ã¤ã‚‚æ®‹ã£ã¦ã„ã¾ã›ã‚“â€¦', level: 'ä¸­ç´š', hint: 'cookiesï¼ˆè¤‡æ•°ï¼‰ã®å¦å®šæ–‡ã¯ï¼Ÿ', choices: ['is', 'are', 'be', "aren't"], answer: 3, explain: 'cookies ã¯è¤‡æ•°ãªã®ã§ There aren\'tï¼ˆare notï¼‰ãŒæ­£ã—ã„ã€‚' },
    { q: 'How many chairs ___ in the classroom?', ja: 'æ•™å®¤ã«ã¯æ¤…å­ãŒä½•è„šã‚ã‚Šã¾ã™ã‹ï¼Ÿ', level: 'ä¸­ç´š', hint: 'ç–‘å•è© How many + è¤‡æ•°åè©ã®ç–‘å•æ–‡ã¯ï¼Ÿ', choices: ['is there', 'are there', 'there is', 'there are'], answer: 1, explain: 'How many chairs? ã¨èãã¨ãã¯ Are there ã‚’ä½¿ã„ã¾ã™ã€‚' },
    { q: 'There ___ a book on the desk.', ja: 'æœºã®ä¸Šã«æœ¬ãŒ1å†Šã‚ã‚Šã¾ã™ã€‚', level: 'åˆç´š', hint: 'a bookï¼ˆå˜æ•°ï¼‰ã«åˆã† beå‹•è©ã¯ï¼Ÿ', choices: ['are', 'am', 'is', 'be'], answer: 2, explain: 'a book ã¯å˜æ•°ãªã®ã§ There is ã‚’ä½¿ã„ã¾ã™ã€‚' },
    { q: '___ a park near your house?', ja: 'ã‚ãªãŸã®å®¶ã®è¿‘ãã«å…¬åœ’ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ', level: 'åˆç´š', hint: 'a parkï¼ˆå˜æ•°ï¼‰ã®ç–‘å•æ–‡ã¯ï¼Ÿ', choices: ['Is there', 'Are there', 'Do there', 'Does there'], answer: 0, explain: 'a park ã¯å˜æ•°ã€‚ç–‘å•æ–‡ã¯ Is there ~? ã§ã™ã€‚' },
    { q: 'There are ___ apples in the basket.', ja: 'ã‹ã”ã®ä¸­ã«ã„ãã¤ã‹ã‚Šã‚“ã”ãŒã‚ã‚Šã¾ã™ã€‚', level: 'åˆç´š', hint: 'è¤‡æ•°ã®ã‚Šã‚“ã”ï¼æ•°é‡ã‚’è¡¨ã™èªã¯ï¼Ÿ', choices: ['a', 'an', 'some', 'much'], answer: 2, explain: 'è¤‡æ•°ã®å¯ç®—åè©ã«ã¯ someï¼ˆã„ãã¤ã‹ã®ï¼‰ã‚’ä½¿ã„ã¾ã™ã€‚' },
    { q: 'There ___ a lot of snow last winter.', ja: 'æ˜¨å¹´ã®å†¬ã¯ãŸãã•ã‚“ã®é›ªãŒé™ã‚Šã¾ã—ãŸã€‚', level: 'ä¸­ç´š', hint: 'beå‹•è©ã®éå»å½¢ï¼snowï¼ˆå˜æ•°æ‰±ã„ï¼‰ã«åˆã†å½¢ã¯ï¼Ÿ', choices: ['is', 'are', 'was', 'were'], answer: 2, explain: 'snow ã¯ä¸å¯ç®—åè©ï¼ˆå˜æ•°æ‰±ã„ï¼‰ãªã®ã§éå»å½¢ã¯ wasã€‚' },
    { q: 'How many students ___ in your class?', ja: 'ã‚ãªãŸã®ã‚¯ãƒ©ã‚¹ã«ã¯ä½•äººã®ç”Ÿå¾’ãŒã„ã¾ã™ã‹ï¼Ÿ', level: 'ä¸­ç´š', hint: 'è¤‡æ•°åè©ã®ç–‘å•æ–‡ï¼', choices: ['is there', 'are there', 'there was', 'there were'], answer: 1, explain: 'students ã¯è¤‡æ•°ãªã®ã§ Are there ã‚’ä½¿ã„ã€How many students are there? ã¨ãªã‚Šã¾ã™ã€‚' },
  ],

  'åŠ©å‹•è©can': [
    { q: 'I ___ swim very well.', ja: 'ç§ã¯ã¨ã¦ã‚‚ä¸Šæ‰‹ã«æ³³ã’ã¾ã™ã€‚', level: 'åˆç´š', hint: 'ï½ã§ãã‚‹ ã‚’è¡¨ã™åŠ©å‹•è©ã¯ï¼Ÿ', choices: ['can', "can't", 'cans', 'canning'], answer: 0, explain: 'ï½ã§ãã‚‹ ã¯ can + å‹•è©ã®åŸå½¢ã§è¡¨ã—ã¾ã™ã€‚' },
    { q: '___ you play the piano?', ja: 'ã‚ãªãŸã¯ãƒ”ã‚¢ãƒã‚’å¼¾ã‘ã¾ã™ã‹ï¼Ÿ', level: 'åˆç´š', hint: 'can ã®ç–‘å•æ–‡ï¼can ã‚’å…ˆé ­ã«å‡ºã™ã¨ï¼Ÿ', choices: ['Can', 'Do', 'Are', 'Will'], answer: 0, explain: 'can ã®ç–‘å•æ–‡ã¯ Can + ä¸»èª + å‹•è©ã®åŸå½¢ï¼Ÿ ã§ã™ã€‚' },
    { q: 'He ___ speak English a little.', ja: 'å½¼ã¯å°‘ã—è‹±èªã‚’è©±ã™ã“ã¨ãŒã§ãã¾ã™ã€‚', level: 'åˆç´š', hint: 'ä¸»èª He + can ã®çµ„ã¿åˆã‚ã›ã¯ï¼Ÿ', choices: ['can', 'cans', "can't", 'canning'], answer: 0, explain: 'can ã¯ä¸»èªãŒä½•ã§ã‚ã£ã¦ã‚‚å½¢ãŒå¤‰ã‚ã‚Šã¾ã›ã‚“ï¼ˆHe cans Ã— â†’ He can â—‹ï¼‰ã€‚' },
    { q: 'We ___ not go to the park because of rain.', ja: 'é›¨ã®ãŸã‚ç§ãŸã¡ã¯å…¬åœ’ã¸è¡Œã‘ã¾ã›ã‚“ã€‚', level: 'åˆç´š', hint: 'ï½ã§ããªã„ ã®å¦å®šå½¢ã¯ï¼Ÿ', choices: ['can', "can't", 'cans', 'could'], answer: 1, explain: 'can ã®å¦å®šã¯ cannot ã¾ãŸã¯ can\'tï¼ˆçŸ­ç¸®å½¢ï¼‰ã§ã™ã€‚' },
    { q: 'My sister ___ ride a bike when she was five.', ja: 'ç§ã®å§‰ï¼ˆå¦¹ï¼‰ã¯5æ­³ã®ã¨ãã«è‡ªè»¢è»Šã«ä¹—ã‚Œã¾ã—ãŸã€‚', level: 'ä¸­ç´š', hint: 'éå»ã®ã€Œã§ããŸã€ã‚’è¡¨ã™å½¢ã¯ï¼Ÿ', choices: ['can', 'could', "can't", 'cans'], answer: 1, explain: 'can ã®éå»å½¢ã¯ couldã€‚ã€Œï½ã§ããŸã€ã¯ could + å‹•è©ã®åŸå½¢ã§ã™ã€‚' },
    { q: '___ I use your pen?', ja: 'ã‚ãªãŸã®ãƒšãƒ³ã‚’ä½¿ã£ã¦ã‚‚ã„ã„ã§ã™ã‹ï¼Ÿ', level: 'åˆç´š', hint: 'è¨±å¯ã‚’æ±‚ã‚ã‚‹è¡¨ç¾ã¯ï¼Ÿ', choices: ['Will', 'Do', 'Can', 'Are'], answer: 2, explain: 'Can I ~? ã¯ã€Œï½ã—ã¦ã‚‚ã„ã„ã§ã™ã‹ï¼Ÿã€ã¨è¨±å¯ã‚’æ±‚ã‚ã‚‹è¡¨ç¾ã§ã™ã€‚' },
    { q: 'She ___ sing very well!', ja: 'å½¼å¥³ã¯ã¨ã¦ã‚‚ä¸Šæ‰‹ã«æ­Œãˆã¾ã™ï¼', level: 'åˆç´š', hint: 'ä¸»èª She + can ã®çµ„ã¿åˆã‚ã›ã¯ï¼Ÿ', choices: ['cans', 'could', 'can', "can't"], answer: 2, explain: 'can ã¯ä¸‰å˜ç¾ã§ã‚‚å¤‰åŒ–ã—ã¾ã›ã‚“ã€‚She can ãŒæ­£ã—ã„ã€‚' },
    { q: 'I ___ find my keys!', ja: 'ç§ã¯éµãŒè¦‹ã¤ã‘ã‚‰ã‚Œã¾ã›ã‚“ï¼', level: 'ä¸­ç´š', hint: 'ã€Œï½ã§ããªã„ã€ã®å¦å®šå½¢ã¯ï¼Ÿ', choices: ['can', 'could', "can't", 'cans'], answer: 2, explain: 'ã€Œè¦‹ã¤ã‘ã‚‰ã‚Œãªã„ã€= can\'t findã€‚can ã®å¦å®šå½¢ã§ã™ã€‚' },
    { q: 'You ___ see the sea from here.', ja: 'ã“ã“ã‹ã‚‰æµ·ãŒè¦‹ãˆã¾ã™ã€‚', level: 'åˆç´š', hint: 'ã€Œã“ã“ã‹ã‚‰æµ·ãŒè¦‹ãˆã‚‹ã€è‚¯å®šæ–‡ã¯ï¼Ÿ', choices: ["can't", 'could', 'can', 'cans'], answer: 2, explain: 'ã€Œï½ã§ãã‚‹ãƒ»ï½ãŒè¦‹ãˆã‚‹ã€= can + å‹•è©ã®åŸå½¢ã§ã™ã€‚' },
    { q: '___ he come to the party?', ja: 'å½¼ã¯ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ã«æ¥ã‚‰ã‚Œã¾ã™ã‹ï¼Ÿ', level: 'åˆç´š', hint: 'can ã®ç–‘å•æ–‡ï¼ˆä¸‰äººç§°å˜æ•°ï¼‰ã¯ï¼Ÿ', choices: ['Does', 'Is', 'Can', 'Will'], answer: 2, explain: 'can ã®ç–‘å•æ–‡ã¯ä¸»èªã«é–¢ã‚ã‚‰ãš Can + ä¸»èª + å‹•è©ã®åŸå½¢ï¼Ÿ ã§ã™ã€‚' },
  ],
};

const unitMeta = {
  'beå‹•è©':    { emoji: 'ğŸ’™' },
  'ä¸€èˆ¬å‹•è©':  { emoji: 'ğŸŒ¸' },
  'ç¾åœ¨é€²è¡Œå½¢':{ emoji: 'ğŸª„' },
  'éå»å½¢':    { emoji: 'ğŸŒ·' },
  'æœªæ¥å½¢':    { emoji: 'ğŸŒ¿' },
  'There is/are':{ emoji: 'ğŸŒ¼' },
  'åŠ©å‹•è©can': { emoji: 'ğŸ«§' },
};

let currentUnit = 'beå‹•è©';
let currentEmoji = 'ğŸ’™';
let questions = [];
let currentQ = 0;
let correctCount = 0;
let answered = false;

// ===== NAVIGATION =====
function navTo(screenId, navEl) {
  showScreen(screenId);
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  navEl.classList.add('active');
  if (screenId === 'records-screen') renderRecords();
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// ===== QUIZ =====

// é›£æ˜“åº¦åˆ¥ã«å•é¡Œã‚’åˆ†é¡ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
function getByLevel(data, level) {
  return data.filter(q => q.level === level);
}

// å˜å…ƒã®ç¿’ç†Ÿåº¦ã‚’åˆ¤å®šï¼ˆåˆç´š15å•å…¨æ­£è§£â†’ä¸­ç´šè§£æ”¾ã€ä¸­ç´š15å•å…¨æ­£è§£â†’ä¸Šç´šè§£æ”¾ï¼‰
function getUnitMastery(unit) {
  const appData = loadData();
  const rec = appData.levelMastery?.[unit] || {};
  // rec.beginner: åˆç´šã‚¯ãƒªã‚¢æ¸ˆã¿ã‹, rec.intermediate: ä¸­ç´šã‚¯ãƒªã‚¢æ¸ˆã¿ã‹
  return {
    beginnerDone: rec.beginnerDone || false,
    intermediateDone: rec.intermediateDone || false,
  };
}

// é›£æ˜“åº¦é…åˆ†ã‚’è€ƒæ…®ã—ãŸquestioné¸æŠ
function selectQuestions(unit) {
  const data = quizData[unit] || [];
  const mastery = getUnitMastery(unit);

  const beginners = getByLevel(data, 'åˆç´š');
  const intermediates = getByLevel(data, 'ä¸­ç´š');
  const advanced = getByLevel(data, 'ä¸Šç´š');

  let pool = [];

  if (!mastery.beginnerDone) {
    // ãƒ•ã‚§ãƒ¼ã‚º1: åˆç´šä¸­å¿ƒï¼ˆåˆç´š5å• or åˆç´š4+ä¸­1ï¼‰
    const bCount = Math.min(beginners.length, 5);
    pool = [...beginners].sort(() => Math.random() - 0.5).slice(0, bCount);
    // åˆç´šãŒ5æœªæº€ãªã‚‰ä¸­ç´šã§è£œå®Œ
    if (pool.length < 5 && intermediates.length > 0) {
      const fill = [...intermediates].sort(() => Math.random() - 0.5).slice(0, 5 - pool.length);
      pool = [...pool, ...fill];
    }
  } else if (!mastery.intermediateDone) {
    // ãƒ•ã‚§ãƒ¼ã‚º2: ä¸­ç´šãƒ¡ã‚¤ãƒ³ï¼ˆä¸­ç´š3+åˆç´š1+ä¸Šç´š1ã€ã¾ãŸã¯ä¸­ç´šå¤šã‚ï¼‰
    const iSlice = [...intermediates].sort(() => Math.random() - 0.5).slice(0, 3);
    const bSlice = [...beginners].sort(() => Math.random() - 0.5).slice(0, 1);
    const aSlice = [...advanced].sort(() => Math.random() - 0.5).slice(0, 1);
    pool = [...iSlice, ...bSlice, ...aSlice].sort(() => Math.random() - 0.5);
    if (pool.length < 5) {
      const extra = [...intermediates, ...beginners].sort(() => Math.random() - 0.5).slice(0, 5 - pool.length);
      pool = [...pool, ...extra];
    }
  } else {
    // ãƒ•ã‚§ãƒ¼ã‚º3: ä¸Šç´šãƒ¡ã‚¤ãƒ³ï¼ˆä¸Šç´š3+ä¸­ç´š1+åˆç´š1ï¼‰
    const aSlice = [...advanced].sort(() => Math.random() - 0.5).slice(0, 3);
    const iSlice = [...intermediates].sort(() => Math.random() - 0.5).slice(0, 1);
    const bSlice = [...beginners].sort(() => Math.random() - 0.5).slice(0, 1);
    pool = [...aSlice, ...iSlice, ...bSlice].sort(() => Math.random() - 0.5);
    if (pool.length < 5) {
      const extra = [...advanced, ...intermediates].sort(() => Math.random() - 0.5).slice(0, 5 - pool.length);
      pool = [...pool, ...extra];
    }
  }

  // é‡è¤‡é™¤å»ã—ã¦æœ€å¤§5å•
  const seen = new Set();
  return pool.filter(q => {
    const k = q.q;
    if (seen.has(k)) return false;
    seen.add(k);
    return true;
  }).slice(0, 5);
}

// çµæœåæ˜ æ™‚ã«ç¿’ç†Ÿåº¦ã‚’æ›´æ–°ï¼ˆquestionStatsã‹ã‚‰é›£æ˜“åº¦åˆ¥æ­£è§£æ•°ã‚’é›†è¨ˆï¼‰
function checkAndUpdateMastery(unit) {
  const appData = loadData();
  if (!appData.levelMastery) appData.levelMastery = {};
  if (!appData.levelMastery[unit]) appData.levelMastery[unit] = {};
  if (!appData.levelCorrect) appData.levelCorrect = {};
  if (!appData.levelCorrect[unit]) appData.levelCorrect[unit] = { 'åˆç´š': 0, 'ä¸­ç´š': 0, 'ä¸Šç´š': 0 };

  // questionStatsã‹ã‚‰å„é›£æ˜“åº¦ã®æ­£è§£åˆè¨ˆã‚’ç®—å‡º
  const stats = appData.questionStats || {};
  const unitData = quizData[unit] || [];
  const counts = { 'åˆç´š': 0, 'ä¸­ç´š': 0, 'ä¸Šç´š': 0 };
  for (const q of unitData) {
    const key = `${unit}::${q.q}`;
    const st = stats[key];
    if (st && st.correct > 0) {
      const lv = q.level || 'åˆç´š';
      counts[lv] += st.correct;
    }
  }

  appData.levelCorrect[unit] = counts;

  // åˆç´š15å•æ­£è§£ç´¯ç©ã§ã‚¯ãƒªã‚¢åˆ¤å®š
  if (!appData.levelMastery[unit].beginnerDone && counts['åˆç´š'] >= 15) {
    appData.levelMastery[unit].beginnerDone = true;
  }
  // ä¸­ç´š15å•æ­£è§£ç´¯ç©ã§ã‚¯ãƒªã‚¢åˆ¤å®š
  if (!appData.levelMastery[unit].intermediateDone && counts['ä¸­ç´š'] >= 15) {
    appData.levelMastery[unit].intermediateDone = true;
  }

  // Unit Clear: å…¨å•ã‚’1å›ä»¥ä¸Šæ­£è§£
  const allAnswered = unitData.every(q => {
    const key = `${unit}::${q.q}`;
    return (stats[key]?.correct || 0) >= 1;
  });
  if (unitData.length > 0) appData.levelMastery[unit].unitClear = allAnswered;

  // Unit Master: å…¨å•ã‚’3å›ä»¥ä¸Šæ­£è§£
  const allMastered = unitData.every(q => {
    const key = `${unit}::${q.q}`;
    return (stats[key]?.correct || 0) >= 3;
  });
  if (unitData.length > 0) appData.levelMastery[unit].unitMaster = allMastered;

  saveData(appData);
}

let weakMode = false;

function startQuiz(unit, emoji) {
  weakMode = false;
  currentUnit = unit;
  currentEmoji = emoji;
  questions = selectQuestions(unit);
  currentQ = 0;
  correctCount = 0;
  loadQuestion();
  showScreen('quiz-screen');
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('nav-home').classList.add('active');
}

function startWeakMode() {
  weakMode = true;
  currentUnit = 'è‹¦æ‰‹ãƒãƒ£ãƒ¬ãƒ³ã‚¸';
  currentEmoji = 'ğŸ¯';

  const appData = loadData();
  const qStats = appData.questionStats || {};

  // å…¨å˜å…ƒã®å•é¡Œã‚’é›†ã‚ã¦æ­£ç­”ç‡ã§ã‚½ãƒ¼ãƒˆ
  let allQ = [];
  for (const [unit, qs] of Object.entries(quizData)) {
    for (const q of qs) {
      const key = `${unit}::${q.q}`;
      const stat = qStats[key] || { correct: 0, total: 0 };
      const rate = stat.total > 0 ? stat.correct / stat.total : 0.5;
      allQ.push({ ...q, _unit: unit, _rate: rate, _key: key });
    }
  }

  // æ­£ç­”ç‡ãŒä½ã„é †ã«ã‚½ãƒ¼ãƒˆï¼ˆåŒç‡ã¯ãƒ©ãƒ³ãƒ€ãƒ ï¼‰
  allQ.sort((a, b) => a._rate - b._rate + (Math.random() - 0.5) * 0.01);

  // å„å˜å…ƒã‹ã‚‰æœ€ä½1å•å…¥ã‚‹ã‚ˆã†ã€ä¸Šä½å¼±å•ã‚’é¸ã¶ï¼ˆæœ€å¤§5å•ï¼‰
  const units = [...new Set(allQ.map(q => q._unit))];
  const selected = [];
  const usedUnits = new Set();

  // ã¾ãšå„å˜å…ƒã®æœ€å¼±å•ã‚’1å•ãšã¤
  for (const unit of units.sort(() => Math.random() - 0.5)) {
    const worst = allQ.find(q => q._unit === unit && !selected.includes(q));
    if (worst) selected.push(worst);
    if (selected.length >= 5) break;
  }

  // 5å•ã«æº€ãŸãªã‘ã‚Œã°å…¨ä½“ã®å¼±å•ã§è£œå®Œ
  if (selected.length < 5) {
    for (const q of allQ) {
      if (!selected.includes(q)) {
        selected.push(q);
        if (selected.length >= 5) break;
      }
    }
  }

  questions = selected.sort(() => Math.random() - 0.5);
  currentQ = 0;
  correctCount = 0;
  loadQuestion();
  showScreen('quiz-screen');
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('nav-home').classList.add('active');
}

function loadQuestion() {
  if (currentQ >= questions.length) { showResult(); return; }
  answered = false;
  const q = questions[currentQ];
  document.getElementById('quiz-unit-tag').textContent = currentEmoji + ' ' + currentUnit;
  document.getElementById('question-text').textContent = q.q;
  document.getElementById('question-ja').textContent = q.ja || '';
  document.getElementById('question-hint').textContent = q.hint;
  document.getElementById('quiz-count').textContent = (currentQ + 1) + '/' + questions.length;
  document.getElementById('quiz-prog-fill').style.width = ((currentQ) / questions.length * 100) + '%';

  const letters = ['A','B','C','D'];
  const choicesEl = document.getElementById('choices');
  choicesEl.innerHTML = '';
  q.choices.forEach((c, i) => {
    const btn = document.createElement('button');
    btn.className = 'choice-btn';
    btn.innerHTML = `<div class="choice-letter">${letters[i]}</div>${c}`;
    btn.onclick = () => selectAnswer(btn, i);
    choicesEl.appendChild(btn);
  });

  document.getElementById('feedback-bar').className = 'feedback-bar';
  document.getElementById('next-btn').className = 'next-btn';
}

function selectAnswer(btn, idx) {
  if (answered) return;
  answered = true;
  const q = questions[currentQ];
  const allBtns = document.querySelectorAll('.choice-btn');
  const isCorrect = idx === q.answer;

  if (isCorrect) {
    btn.classList.add('correct');
    correctCount++;
    showFeedback(true, q.explain);
    spawnParticles();
  } else {
    btn.classList.add('wrong');
    allBtns[q.answer].classList.add('correct');
    showFeedback(false, q.explain);
  }

  allBtns.forEach(b => { if (b !== btn && !b.classList.contains('correct')) b.classList.add('disabled'); });
  document.getElementById('next-btn').className = 'next-btn show';

  // å•é¡Œã”ã¨ã®çµ±è¨ˆã‚’è¨˜éŒ²
  const unitKey = q._unit || currentUnit;
  const qKey = `${unitKey}::${q.q}`;
  const appData = loadData();
  if (!appData.questionStats) appData.questionStats = {};
  if (!appData.questionStats[qKey]) appData.questionStats[qKey] = { correct: 0, total: 0 };
  appData.questionStats[qKey].total++;
  if (isCorrect) appData.questionStats[qKey].correct++;
  saveData(appData);
}

function showFeedback(correct, note) {
  const bar = document.getElementById('feedback-bar');
  bar.className = 'feedback-bar show ' + (correct ? 'correct-fb' : 'wrong-fb');
  document.getElementById('feedback-icon').textContent = correct ? 'âœ¨' : 'ğŸ’­';
  document.getElementById('feedback-title').textContent = correct ? 'æ­£è§£ï¼ã‚„ã£ãŸã­ï¼' : 'ãŠã—ã‹ã£ãŸâ€¦';
  document.getElementById('feedback-note').textContent = note;
}

function nextQuestion() {
  currentQ++;
  loadQuestion();
}

function showResult() {
  document.getElementById('quiz-prog-fill').style.width = '100%';
  const pct = Math.round(correctCount / questions.length * 100);
  document.getElementById('res-score').textContent = correctCount;
  document.getElementById('res-total').textContent = questions.length;
  document.getElementById('res-pct').textContent = pct + '%';

  // Save to localStorage
  const appData = loadData();
  updateStreak(appData);

  // Unit stats
  if (!appData.unitStats[currentUnit]) appData.unitStats[currentUnit] = { total: 0, correct: 0 };
  appData.unitStats[currentUnit].total += questions.length;
  appData.unitStats[currentUnit].correct += correctCount;

  // Week log
  const today = todayStr();
  appData.weekLog[today] = (appData.weekLog[today] || 0) + questions.length;

  // History (keep last 20)
  appData.history.unshift({
    unit: currentUnit,
    emoji: currentEmoji,
    score: correctCount,
    total: questions.length,
    pct,
    date: today
  });
  if (appData.history.length > 20) appData.history = appData.history.slice(0, 20);

  saveData(appData);

  // ç¿’ç†Ÿåº¦ãƒã‚§ãƒƒã‚¯ï¼ˆé€šå¸¸ã‚¯ã‚¤ã‚ºã®ã¿ï¼‰
  if (!weakMode) {
    checkAndUpdateMastery(currentUnit);
  }

  updateStreakPill(appData.streak);
  updateMasteryBadge();

  // ç²å¾—ãƒãƒƒã‚¸ï¼ˆå‹•çš„ï¼‰
  const badgeRow = document.getElementById('badge-row');
  badgeRow.innerHTML = '';
  const freshData = loadData();
  // Perfectåˆ¤å®š: å•é¡Œæ•°ãŒ1å•ä»¥ä¸Šã‹ã¤å…¨å•æ­£è§£
  const isPerfect = questions.length > 0 && correctCount === questions.length;
  if (isPerfect) {
    const b = document.createElement('div');
    b.className = 'badge-chip'; b.textContent = 'ğŸŒŸ Perfect!';
    badgeRow.appendChild(b);
  }
  if (freshData.streak >= 3) {
    const b = document.createElement('div');
    b.className = 'badge-chip'; b.textContent = `ğŸ”¥ ${freshData.streak}æ—¥é€£ç¶š`;
    badgeRow.appendChild(b);
  }
  if (!weakMode && freshData.levelMastery?.[currentUnit]?.unitMaster) {
    const b = document.createElement('div');
    b.className = 'badge-chip'; b.textContent = 'ğŸ‘‘ Unit Master!';
    badgeRow.appendChild(b);
  } else if (!weakMode && freshData.levelMastery?.[currentUnit]?.unitClear) {
    const b = document.createElement('div');
    b.className = 'badge-chip'; b.textContent = 'âœ¨ Unit Clear!';
    badgeRow.appendChild(b);
  }
  if (badgeRow.children.length === 0) {
    document.getElementById('badges-section').style.display = 'none';
  } else {
    document.getElementById('badges-section').style.display = '';
  }

  let illus, comment, sub;
  if (isPerfect && freshData.levelMastery?.[currentUnit]?.unitMaster) {
    illus = 'ğŸ‘‘'; comment = 'Unit Masteré”æˆï¼ï¼'; sub = currentUnit + 'ã‚’å®Œå…¨åˆ¶è¦‡ã—ãŸã‚ˆğŸ‰';
  } else if (isPerfect && freshData.levelMastery?.[currentUnit]?.unitClear) {
    illus = 'âœ¨'; comment = 'Unit Clearï¼ã™ã”ã„ï¼'; sub = currentUnit + 'ã€å…¨å•ã‚¯ãƒªã‚¢ã—ãŸã‚ˆğŸŒ¸';
  } else if (isPerfect) {
    illus = 'ğŸŒ¸'; comment = 'Perfect! æº€ç‚¹ã ã‚ˆï¼'; sub = currentUnit + 'ã€å®Œå…¨ãƒã‚¹ã‚¿ãƒ¼ã—ãŸâœ¨';
  } else if (pct >= 70) { illus = 'â­'; comment = 'ã™ã”ã„ï¼ã‚ˆãã§ããŸã­'; sub = 'æ¬¡ã¯ã‚‚ã£ã¨ä¸Šã‚’ç›®æŒ‡ãã†ï¼'; }
  else if (pct >= 50) { illus = 'ğŸŒ¿'; comment = 'ãŒã‚“ã°ã£ãŸã­ï¼'; sub = 'ã‚‚ã†ä¸€åº¦ã‚„ã£ã¦ã¿ã‚‹ã¨å®Œç’§ã«ãªã‚Œã‚‹ã‚ˆ'; }
  else { illus = 'ğŸ’™'; comment = 'ãƒ‰ãƒ³ãƒã‚¤ï¼ä¸€ç·’ã«å¾©ç¿’ã—ã‚ˆã†'; sub = 'ç·´ç¿’ãŒå¤§äº‹ï¼ã¾ãŸæŒ‘æˆ¦ã—ã¦ã­'; }

  document.getElementById('result-illus').textContent = illus;
  document.getElementById('result-comment').textContent = comment;
  document.getElementById('result-sub').textContent = sub;
  showScreen('result-screen');
}


function updateMasteryBadge() {
  // Unit cards: update badge row for Clear/Master
  const appData = loadData();
  document.querySelectorAll('.unit-card[data-unit]').forEach(card => {
    const unit = card.dataset.unit;
    const mastery = appData.levelMastery?.[unit] || {};
    // Remove old badge row if present
    const oldRow = card.querySelector('.unit-badge-row');
    if (oldRow) oldRow.remove();
    const oldDone = card.querySelector('.unit-done');

    if (mastery.unitMaster) {
      if (oldDone) oldDone.remove();
      const row = document.createElement('div');
      row.className = 'unit-badge-row';
      row.innerHTML = '<span class="unit-badge-pill unit-badge-master">ğŸ‘‘ Master</span><span class="unit-badge-pill unit-badge-clear">âœ“ Clear</span>';
      card.appendChild(row);
    } else if (mastery.unitClear) {
      if (oldDone) oldDone.remove();
      const row = document.createElement('div');
      row.className = 'unit-badge-row';
      row.innerHTML = '<span class="unit-badge-pill unit-badge-clear">âœ“ Clear</span>';
      card.appendChild(row);
    }
    // If neither, keep the original .unit-done or .unit-progress as-is
  });
}

function updateStreakPill(streak) {
  document.querySelector('.streak-pill').innerHTML =
    `<span class="streak-flame">ğŸ”¥</span><span>${streak}æ—¥é€£ç¶š</span>`;
}

function spawnParticles() {
  const emojis = ['âœ¨','ğŸŒ¸','â­','ğŸ’™','ğŸª„'];
  for (let i = 0; i < 6; i++) {
    setTimeout(() => {
      const p = document.createElement('div');
      p.className = 'particle';
      p.textContent = emojis[Math.floor(Math.random() * emojis.length)];
      p.style.left = (20 + Math.random() * 60) + 'vw';
      p.style.top = (30 + Math.random() * 30) + 'vh';
      p.style.animationDelay = (Math.random() * 0.3) + 's';
      document.body.appendChild(p);
      setTimeout(() => p.remove(), 1500);
    }, i * 80);
  }
}

// ===== RECORDS SCREEN =====
function renderRecords() {
  const data = loadData();
  const today = todayStr();

  // Stats
  document.getElementById('rec-streak').textContent = data.streak;

  let totalQ = 0, totalC = 0;
  Object.values(data.unitStats).forEach(s => { totalQ += s.total; totalC += s.correct; });
  document.getElementById('rec-total-q').textContent = totalQ;
  document.getElementById('rec-accuracy').textContent = totalQ > 0 ? Math.round(totalC / totalQ * 100) + '%' : '-%';

  // Week calendar (Mon-Sun of current week)
  const dayNames = ['æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ','æ—¥'];
  const cal = document.getElementById('week-calendar');
  cal.innerHTML = '';
  const now = new Date();
  // Get Monday of this week
  const dow = now.getDay(); // 0=Sun
  const mondayOffset = dow === 0 ? -6 : 1 - dow;
  for (let i = 0; i < 7; i++) {
    const d = new Date(now);
    d.setDate(now.getDate() + mondayOffset + i);
    const dStr = d.toISOString().slice(0, 10);
    const count = data.weekLog[dStr] || 0;
    const isToday = dStr === today;
    const isDone = count > 0;
    const cell = document.createElement('div');
    cell.className = 'day-cell';
    cell.innerHTML = `
      <div class="day-label">${dayNames[i]}</div>
      <div class="day-dot${isDone ? ' done' : ''}${isToday ? ' today' : ''}">${isDone ? 'âœ“' : ''}</div>
      <div class="day-questions">${count > 0 ? count + 'å•' : ''}</div>
    `;
    cal.appendChild(cell);
  }

  // Unit accuracy
  const accList = document.getElementById('unit-accuracy-list');
  accList.innerHTML = '';
  const unitEntries = Object.entries(data.unitStats);
  if (unitEntries.length === 0) {
    accList.innerHTML = '<div class="history-empty">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
  } else {
    unitEntries.forEach(([unit, stat]) => {
      const pct = Math.round(stat.correct / stat.total * 100);
      const emoji = (unitMeta[unit] || {}).emoji || 'ğŸ“';
      const row = document.createElement('div');
      row.className = 'unit-acc-row';
      row.innerHTML = `
        <div class="unit-acc-icon">${emoji}</div>
        <div class="unit-acc-info">
          <div class="unit-acc-name">${unit}</div>
          <div class="unit-acc-bar-bg">
            <div class="unit-acc-bar-fill" style="width:${pct}%"></div>
          </div>
        </div>
        <div class="unit-acc-pct">${pct}%</div>
      `;
      accList.appendChild(row);
    });
  }

  // History
  const histList = document.getElementById('history-list');
  histList.innerHTML = '';
  if (data.history.length === 0) {
    histList.innerHTML = '<div class="history-empty">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“<br>ã‚¯ã‚¤ã‚ºã«æŒ‘æˆ¦ã—ã¦ã¿ã‚ˆã†ï¼</div>';
  } else {
    data.history.slice(0, 10).forEach(h => {
      const d = new Date(h.date);
      const dateStr = `${d.getMonth()+1}/${d.getDate()}`;
      const item = document.createElement('div');
      item.className = 'history-item';
      item.innerHTML = `
        <div class="history-icon">${h.emoji}</div>
        <div class="history-info">
          <div class="history-unit">${h.unit}</div>
          <div class="history-date">${dateStr}</div>
        </div>
        <div class="history-score">${h.score}/${h.total}<span>${h.pct}%</span></div>
      `;
      histList.appendChild(item);
    });
  }
}

// ===== INIT =====
window.addEventListener('DOMContentLoaded', () => {
  const data = loadData();
  if (data.streak > 0) updateStreakPill(data.streak);
  // Notionã‹ã‚‰æœ€æ–°å•é¡Œã‚’å–å¾—
  fetchQuestionsFromNotion();
});
</script>

<!-- Service Worker ç™»éŒ² -->
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js')
        .then(reg => console.log('SW registered:', reg.scope))
        .catch(err => console.log('SW error:', err));
    });
  }
</script>
</body>
</html>
